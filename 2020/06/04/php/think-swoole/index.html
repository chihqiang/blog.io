<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>think-swoole基本使用 | 志强vlog</title><meta name="keywords" content="swoole,think-swoole"><meta name="description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta property="og:type" content="article"><meta property="og:title" content="think-swoole基本使用 | 志强vlog"><meta property="og:description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta property="og:url" content="https://www.zhiqiang.wang/2020/06/04/php/think-swoole/"><meta property="og:image" content="/img/favicon.ico"><meta property="og:site_name" content="志强vlog"><meta property="article:published_time" content="Thu Jun 04 2020 11:00:00 GMT+0800"><meta property="article:author" content="王志强"><meta property="article:tag" content="swoole"><meta property="article:tag" content="think-swoole"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="think-swoole基本使用 | 志强vlog"><meta name="twitter:description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta name="twitter:image" content="/img/favicon.ico"><script type="application/ld+json">{
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "think-swoole基本使用",
      "image": "/img/favicon.ico",
      "author": {
        "@type": "Person",
        "name": "王志强"
      },
      "datePublished": "Thu Jun 04 2020 11:00:00 GMT+0800",
      "dateModified": "Thu Jan 08 2026 06:03:16 GMT+0000",
      "description": "志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"
    }</script><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"><script>"dark"===localStorage.getItem("theme")||!localStorage.getItem("theme")&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><script src="https://cdn.tailwindcss.com/3.4.16"></script><script>tailwind.config={darkMode:"class",theme:{extend:{}}}</script><script src="https://unpkg.com/alpinejs@3.14.9/dist/cdn.min.js" defer></script><link rel="stylesheet" href="/css/blog.css"><script src="/js/blog.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body class="bg-gradient-to-br from-purple-100 to-blue-100 dark:from-gray-900 dark:to-gray-800 min-h-screen flex flex-col transition-colors duration-300"><nav id="navbar" class="bg-gradient-to-r from-purple-600 to-blue-500 shadow-lg dark:from-gray-800 dark:to-gray-700 transition-all duration-300 sticky top-0 z-40"><div class="container mx-auto px-4 py-3"><div class="flex justify-between items-center"><h1 class="text-white text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-pink-400"><a href="/">志强vlog</a></h1><div id="desktop-menu" class="hidden lg:flex items-center space-x-1"><a href="/" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="0">Home </a><a href="/archives" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="1">Archives </a><a href="/resources" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="2">Rsources </a><a href="/tags" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="3">Tags </a><a href="/about" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="4">About </a><a href="/sitemap.xml" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="5">RSS</a><div id="dropdown-menu" class="relative group hidden"><button class="text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10 flex items-center">更多 <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="dropdown-content" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0"></div></div></div><div class="flex items-center space-x-1 sm:space-x-2"><button id="searchButton" class="p-2 sm:p-2.5 rounded-full bg-white/20 hover:bg-white/30 transition-all duration-300 text-white hover:scale-110 active:scale-95" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button> <button id="theme-toggle" class="p-2 sm:p-2.5 rounded-full bg-white/20 hover:bg-white/30 transition-all duration-300 text-white hover:scale-110 active:scale-95" aria-label="切换主题"><svg id="sun-icon" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg> <svg id="moon-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg></button> <button id="mobile-menu-button" aria-label="切换菜单" class="lg:hidden p-2 sm:p-2.5 rounded-lg hover:bg-white/10 transition-all duration-300 text-white hover:scale-110 active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div></div></div><div id="mobile-menu" class="lg:hidden hidden bg-gradient-to-r from-purple-600 to-blue-500 dark:from-gray-800 dark:to-gray-700 px-4 pb-4 transition-all duration-300"><div class="space-y-1"><a href="/" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Home</span> </a><a href="/archives" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Archives</span> </a><a href="/resources" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Rsources</span> </a><a href="/tags" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Tags</span> </a><a href="/about" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">About</span> </a><a href="/sitemap.xml" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">RSS</span></a></div></div></nav><div id="searchOverlay" class="overlay hidden"></div><div id="inputContainer" class="floating-search hidden"><input type="text" id="inputField" placeholder="搜索文章..." class="search-input" autocomplete="off"><div id="articleList" class="search-results"></div></div><script>document.addEventListener("DOMContentLoaded",DOMContentLoadedSearch)</script><div id="reading-progress" class="fixed top-0 left-0 h-1 bg-gradient-to-r from-purple-500 to-blue-500 z-50 transition-all duration-150" style="width:0%"></div><div class="container mx-auto px-4 py-8"><article class="bg-white p-6 sm:p-8 rounded-xl shadow-lg transition hover:scale-[1.01] max-w-5xl mx-auto mt-8"><header class="mb-6 sm:mb-8"><h1 class="text-3xl sm:text-4xl font-bold mb-3 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">think-swoole基本使用</h1><div class="flex flex-wrap items-center text-gray-500 text-sm space-x-4"><span>2020-06-04</span> <span><a href="/categories/php/" class="text-blue-600 hover:underline">php</a> </span><span><a href="/tags/swoole/" class="text-blue-600 hover:underline">swoole</a>, <a href="/tags/think-swoole/" class="text-blue-600 hover:underline">think-swoole</a></span></div></header><div class="article-content prose prose-base lg:prose-lg max-w-none"><h2 id="官网文档"><a href="#官网文档" class="headerlink" title="官网文档"></a>官网文档</h2><blockquote><p>thinkphp6文档<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp6_0/1037479">https://www.kancloud.cn/manual/thinkphp6_0/1037479</a></p><p>swoole文档<br><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/">https://wiki.swoole.com/#/</a></p><p>think-swoole文档<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp6_0/1359700">https://www.kancloud.cn/manual/thinkphp6_0/1359700</a></p></blockquote><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require topthink/think-swoole</span><br></pre></td></tr></table></figure><h2 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think swoole [start|stop|reload|restart]</span><br></pre></td></tr></table></figure><h2 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h2><p>当你在命令行<code>php think swoole</code>下执行完成之后就会启动一个HTTP Server，可以直接访问当前的应用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;server&#x27;</span>     =&gt; [</span><br><span class="line">    <span class="string">&#x27;host&#x27;</span>      =&gt; <span class="built_in">env</span>(<span class="string">&#x27;SWOOLE_HOST&#x27;</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>), // 监听地址</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span>      =&gt; <span class="built_in">env</span>(<span class="string">&#x27;SWOOLE_PORT&#x27;</span>, 9501), // 监听端口</span><br><span class="line">    <span class="string">&#x27;mode&#x27;</span>      =&gt; SWOOLE_PROCESS, // 运行模式 默认为SWOOLE_PROCESS</span><br><span class="line">    <span class="string">&#x27;sock_type&#x27;</span> =&gt; SWOOLE_SOCK_TCP, // sock <span class="built_in">type</span> 默认为SWOOLE_SOCK_TCP</span><br><span class="line">    <span class="string">&#x27;options&#x27;</span>   =&gt; [</span><br><span class="line">     // 服务启动后，进程ID存放文件</span><br><span class="line">        <span class="string">&#x27;pid_file&#x27;</span>              =&gt; runtime_path() . <span class="string">&#x27;swoole.pid&#x27;</span>,</span><br><span class="line">        // swoole 的日志文件</span><br><span class="line">        <span class="string">&#x27;log_file&#x27;</span>              =&gt; runtime_path() . <span class="string">&#x27;swoole.log&#x27;</span>,</span><br><span class="line">        // 守护进程模式设置 <span class="literal">true</span> 后台运行</span><br><span class="line">        <span class="string">&#x27;daemonize&#x27;</span>             =&gt; <span class="literal">false</span>,</span><br><span class="line">        // 设置启动的reactor线程数</span><br><span class="line">        <span class="string">&#x27;reactor_num&#x27;</span>           =&gt; swoole_cpu_num(),</span><br><span class="line">        // 设置启动的worker进程数</span><br><span class="line">        <span class="string">&#x27;worker_num&#x27;</span>            =&gt; swoole_cpu_num(),</span><br><span class="line">        //配置Task进程的数量</span><br><span class="line">        <span class="string">&#x27;task_worker_num&#x27;</span>       =&gt; swoole_cpu_num(),</span><br><span class="line">        //开启静态文件请求处理，需配合document_root</span><br><span class="line">        <span class="string">&#x27;enable_static_handler&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">        //静态文件根目录</span><br><span class="line">        <span class="string">&#x27;document_root&#x27;</span>         =&gt; root_path(<span class="string">&#x27;public&#x27;</span>),</span><br><span class="line">        // 设置最大数据包尺寸，单位字节</span><br><span class="line">        <span class="string">&#x27;package_max_length&#x27;</span>    =&gt; 20 * 1024 * 1024,</span><br><span class="line">        //配置发送输出缓冲区内存尺寸</span><br><span class="line">        <span class="string">&#x27;buffer_output_size&#x27;</span>    =&gt; 10 * 1024 * 1024,</span><br><span class="line">        //设置客户端连接最大允许占用的内存数量</span><br><span class="line">        <span class="string">&#x27;socket_buffer_size&#x27;</span>    =&gt; 128 * 1024 * 1024,</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><h2 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h2><p>swoole服务器运行过程中php文件是常驻内存运行，这样就可以避免重复的读取磁盘，重复的解释编译php，以便达到最高的性能，所以修改代码需要重启服务</p><p>think-swoole扩展提供热更新功能，在检测相关文件有更新会自动重启，不在需要手动完成重启，方便开发调试</p><p>生产环境下不建议开始文件监控，性能损耗，正常情况下你所修改的文件需要确认无误才能进行更新部署</p><p><code>.env</code>里面设置<code>APP_DEBUG = true</code>会默认开启热更新</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;hot_update&#x27;</span> =&gt; [</span><br><span class="line">    <span class="string">&#x27;enable&#x27;</span>  =&gt; <span class="built_in">env</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>, <span class="literal">false</span>),</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>    =&gt; [<span class="string">&#x27;*.php&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;include&#x27;</span> =&gt; [app_path()],</span><br><span class="line">    <span class="string">&#x27;exclude&#x27;</span> =&gt; [],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>参数说明</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>enable</td><td>是否开启热更新</td></tr><tr><td>name</td><td>监听哪些类型的文件变动</td></tr><tr><td>include</td><td>监听哪些目录下的文件变动</td></tr><tr><td>exclude</td><td>排除目录</td></tr></tbody></table><h2 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h2><p>先来一个官方的例子</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server</span> = new Swoole\WebSocket\Server(<span class="string">&quot;0.0.0.0&quot;</span>, 9501);</span><br><span class="line"><span class="variable">$server</span>-&gt;on(<span class="string">&#x27;open&#x27;</span>, <span class="keyword">function</span> (Swoole\WebSocket\Server <span class="variable">$server</span>, <span class="variable">$request</span>) &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;server: handshake success with fd&#123;<span class="variable">$request</span>-&gt;fd&#125;\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable">$server</span>-&gt;on(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (Swoole\WebSocket\Server <span class="variable">$server</span>, <span class="variable">$frame</span>) &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;receive from &#123;<span class="variable">$frame</span>-&gt;fd&#125;:&#123;<span class="variable">$frame</span>-&gt;data&#125;\n&quot;</span>;</span><br><span class="line">    <span class="variable">$server</span>-&gt;push(<span class="variable">$frame</span>-&gt;fd, <span class="string">&quot;this is server&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable">$server</span>-&gt;on(<span class="string">&#x27;close&#x27;</span>, <span class="keyword">function</span> (<span class="variable">$ser</span>, <span class="variable">$fd</span>) &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;client &#123;<span class="variable">$fd</span>&#125; closed\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable">$server</span>-&gt;start();</span><br></pre></td></tr></table></figure><p>开启think-swoole的websocket功能 <code>\config\swoole.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;websocket&#x27;</span>  =&gt; [</span><br><span class="line"> <span class="string">&#x27;enable&#x27;</span>        =&gt; <span class="literal">true</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>创建三个事件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwWsConnect</span><br><span class="line">php think make:listener SwWsClose</span><br><span class="line">php think make:listener SwWsMessage</span><br></pre></td></tr></table></figure><p>然后将这三个事件写到到事件监听中，分别有以下2中文件可以修改方式，注意二选一</p><p>thinkphp6自带的事件绑定<code>app\event.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="string">&#x27;listen&#x27;</span>    =&gt; [</span><br><span class="line">........</span><br><span class="line">      // 监听链接</span><br><span class="line">      <span class="string">&#x27;swoole.websocket.Connect&#x27;</span> =&gt; [</span><br><span class="line">          \app\listener\SwWsConnect::class</span><br><span class="line">      ],</span><br><span class="line">      //关闭连接</span><br><span class="line">      <span class="string">&#x27;swoole.websocket.Close&#x27;</span> =&gt; [</span><br><span class="line">          \app\listener\SwWsClose::class</span><br><span class="line">      ],</span><br><span class="line">      //发送消息场景</span><br><span class="line">      <span class="string">&#x27;swoole.websocket.Message&#x27;</span> =&gt; [</span><br><span class="line">          \app\listener\SwWsMessage::class</span><br><span class="line">      ]</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure><p>think-swoole事件绑定<code>config\swoole.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;listen&#x27;</span>        =&gt; [</span><br><span class="line">    <span class="string">&#x27;connect&#x27;</span>=&gt;\app\listener\SwWsConnect::class,</span><br><span class="line">    <span class="string">&#x27;close&#x27;</span>=&gt;\app\listener\SwWsClose::class,</span><br><span class="line">    <span class="string">&#x27;message&#x27;</span>=&gt; \app\listener\SwWsMessage::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><blockquote><p>怎么选择是保存在<code>config\swoole.php</code>还是<code>app\event.php</code>配置中呢？</p><p>首先我们 我们确定一下我们这个项目中存在有几个实时通讯，</p><p>如果只是存在一个实时通讯 个人建议 保存在<code>config\swoole.php</code></p><p>如果是存在多个实时通讯，就保存在<code>app\event.php</code></p><p>key值 必须是<code>swoole.websocket.事件名称</code> 例如 <code>swoole.websocket.Message</code></p></blockquote><p>开始写事件中中方法</p><p>连接事件<code>app\listener\SwWsConnect.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>, \think\swoole\websocket <span class="variable">$ws</span>)</span><br><span class="line">&#123;</span><br><span class="line">    // 获取当前发送者的fd</span><br><span class="line">    <span class="variable">$fd</span> = <span class="variable">$ws</span>-&gt;getSender();</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;server: handshake success with fd&#123;<span class="variable">$fd</span>&#125;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关闭事件<code>app\listener\SwWsClose.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>, \think\swoole\websocket <span class="variable">$ws</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$fd</span> = <span class="variable">$ws</span>-&gt;getSender();</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;client &#123;<span class="variable">$fd</span>&#125; closed\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>message事件<code>app\listener\SwWsMessage.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>, \think\swoole\websocket <span class="variable">$ws</span>)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="variable">$fd</span> = <span class="variable">$ws</span>-&gt;getSender();</span><br><span class="line"> <span class="variable">$data</span> = json_encode(<span class="variable">$event</span>);</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;receive from &#123;<span class="variable">$fd</span>&#125;:&#123;<span class="variable">$data</span>&#125;\n&quot;</span>;</span><br><span class="line">    <span class="variable">$ws</span>-&gt;emit(<span class="string">&quot;this is server&quot;</span>, <span class="variable">$fd</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动<code>php think swoole</code>进行测试</p><p>think-swoole中的websocket方法总结</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//给自己发消息</span><br><span class="line"><span class="variable">$ws</span>-&gt;emit(<span class="string">&quot;this is server&quot;</span>, <span class="variable">$ws</span>-&gt;getSender());</span><br><span class="line">//给指定一个fd发消息</span><br><span class="line"><span class="variable">$ws</span>-&gt;to(<span class="variable">$to</span>)-&gt;emit(<span class="string">&quot;messagecallback&quot;</span>,<span class="variable">$data</span>);</span><br><span class="line">//给指定多个人发消息</span><br><span class="line"><span class="variable">$ws</span>-&gt;to([1,2,3])-&gt;emit(<span class="string">&quot;messagecallback&quot;</span>,<span class="variable">$data</span>);</span><br><span class="line">//发送给所有的(不包含自己)</span><br><span class="line"><span class="variable">$ws</span>-&gt;broadcast()-&gt;emit(<span class="string">&quot;messagecallback&quot;</span>,<span class="variable">$data</span>);</span><br><span class="line">//模拟formfd 给tofd 发送消息</span><br><span class="line"><span class="variable">$ws</span>-&gt;setSender(<span class="variable">$formfd</span>)-&gt;to(<span class="variable">$tofd</span>)-&gt;emit(<span class="string">&quot;messagecallback&quot;</span>,<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure><blockquote><p>注意：在多个实时通讯场景下使用 <code>emit</code></p><p>第一个参数传入 传入 事件名称callback 例如 <code>messagecallback</code></p></blockquote><p>如果你发现你think-swoole中有些没有swoole中的方法可以这么干</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sw</span> = app(<span class="string">&#x27;swoole.server&#x27;</span>);</span><br><span class="line"><span class="variable">$sw</span> = app(<span class="string">&quot;think\swoole\Manager&quot;</span>)-&gt;getServer();</span><br><span class="line">//以上二选一</span><br><span class="line"></span><br><span class="line"><span class="variable">$es</span> = <span class="variable">$sw</span>-&gt;isEstablished(<span class="variable">$fd</span>); //检查连接是否为有效的WebSocket客户端连接</span><br><span class="line">var_dump(<span class="variable">$es</span>);</span><br></pre></td></tr></table></figure><h2 id="聊天室room实现"><a href="#聊天室room实现" class="headerlink" title="聊天室room实现"></a>聊天室room实现</h2><p>前端文件参考 <code>html\room.html</code> 或 <code>html\room-socket-io.html</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwRoomJoin</span><br><span class="line">php think make:listener SwRoomLeave</span><br><span class="line">php think make:listener SwRoomMessage</span><br></pre></td></tr></table></figure><p>事件绑定</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 加入房间</span><br><span class="line"><span class="string">&#x27;swoole.websocket.RoomJoin&#x27;</span> =&gt; [</span><br><span class="line"> \app\listener\SwRoomJoin::class</span><br><span class="line">],</span><br><span class="line">// 离开房间</span><br><span class="line"><span class="string">&#x27;swoole.websocket.Roomleave&#x27;</span> =&gt; [</span><br><span class="line"> \app\listener\SwRoomLeave::class</span><br><span class="line">],</span><br><span class="line">// 在房间发消息</span><br><span class="line"><span class="string">&#x27;swoole.websocket.RoomMessage&#x27;</span> =&gt; [</span><br><span class="line"> \app\listener\SwRoomMessage::class</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>加入房间逻辑</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>, \think\swoole\websocket <span class="variable">$ws</span>, \think\swoole\websocket\room <span class="variable">$room</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$fd</span> = <span class="variable">$ws</span>-&gt;getSender();</span><br><span class="line">    //客户端假如定的room</span><br><span class="line">    <span class="variable">$roomid</span> = <span class="variable">$event</span>[<span class="string">&#x27;room&#x27;</span>];</span><br><span class="line">    //获取指定房间下有哪些客户端</span><br><span class="line">    <span class="variable">$roomfds</span> = <span class="variable">$room</span>-&gt;getClients(<span class="variable">$roomid</span>);</span><br><span class="line">    // 判断这个房间有没有自己 如果有自己就不需要再次发送通知</span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="variable">$fd</span>, <span class="variable">$roomfds</span>)) &#123;</span><br><span class="line">        <span class="variable">$ws</span>-&gt;to(<span class="variable">$roomfds</span>)-&gt;emit(<span class="string">&quot;roomjoincallback&quot;</span>, <span class="string">&quot;房间&#123;<span class="variable">$roomid</span>&#125;已加入&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    //加入房间</span><br><span class="line">    <span class="variable">$ws</span>-&gt;<span class="built_in">join</span>(<span class="variable">$roomid</span>);</span><br><span class="line">    <span class="variable">$ws</span>-&gt;to(<span class="variable">$roomfds</span>)-&gt;emit(<span class="string">&quot;roomjoincallback&quot;</span>, <span class="string">&quot;&#123;<span class="variable">$fd</span>&#125;加入房间&#123;<span class="variable">$roomid</span>&#125;成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>离开房间逻辑</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>, \think\swoole\websocket <span class="variable">$ws</span>, \think\swoole\websocket\Room <span class="variable">$room</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$roomid</span> = <span class="variable">$event</span>[<span class="string">&#x27;room&#x27;</span>];</span><br><span class="line">    <span class="variable">$fd</span> = <span class="variable">$ws</span>-&gt;getSender();</span><br><span class="line">    <span class="variable">$roomfds</span> = <span class="variable">$room</span>-&gt;getClients(<span class="variable">$roomid</span>);</span><br><span class="line">    <span class="keyword">if</span> (!in_array(<span class="variable">$fd</span>, <span class="variable">$roomfds</span>)) &#123;</span><br><span class="line">        <span class="variable">$ws</span>-&gt;emit(<span class="string">&quot;roomleavecallback&quot;</span>, <span class="string">&quot;&#123;<span class="variable">$fd</span>&#125;不在&#123;<span class="variable">$roomid</span>&#125;房间内，怎么离开~&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    //离开房间</span><br><span class="line">    <span class="variable">$ws</span>-&gt;leave(<span class="variable">$roomid</span>);</span><br><span class="line">    //获取当前客户端加入了哪些客户端</span><br><span class="line">    <span class="variable">$rooms</span> = <span class="variable">$room</span>-&gt;getRooms(<span class="variable">$fd</span>);</span><br><span class="line">    <span class="variable">$ws</span>-&gt;to(<span class="variable">$roomfds</span>)-&gt;emit(<span class="string">&quot;roomleavecallback&quot;</span>, <span class="string">&quot;&#123;<span class="variable">$fd</span>&#125;已离开了~~&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在房间发布聊天逻辑</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>, \think\swoole\websocket <span class="variable">$ws</span>, \think\swoole\websocket\room <span class="variable">$room</span>)</span><br><span class="line">&#123;</span><br><span class="line">    //</span><br><span class="line">    <span class="variable">$roomid</span> = <span class="variable">$event</span>[<span class="string">&#x27;room&#x27;</span>];</span><br><span class="line">    <span class="variable">$text</span> = <span class="variable">$event</span>[<span class="string">&#x27;text&#x27;</span>];</span><br><span class="line">    <span class="variable">$fd</span> = <span class="variable">$ws</span>-&gt;getSender();</span><br><span class="line">    <span class="variable">$roomfds</span> = <span class="variable">$room</span>-&gt;getClients(<span class="variable">$roomid</span>);</span><br><span class="line">    <span class="keyword">if</span> (!in_array(<span class="variable">$fd</span>, <span class="variable">$roomfds</span>)) &#123;</span><br><span class="line">        <span class="variable">$ws</span>-&gt;emit(<span class="string">&quot;roommessagecallback&quot;</span>, <span class="string">&quot;&#123;<span class="variable">$fd</span>&#125;不在&#123;<span class="variable">$roomid</span>&#125;房间内，无法进入发布聊天~&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$ws</span>-&gt;to(<span class="variable">$roomfds</span>)-&gt;emit(<span class="string">&quot;roommessagecallback&quot;</span>,  <span class="variable">$text</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="事件订阅"><a href="#事件订阅" class="headerlink" title="事件订阅"></a>事件订阅</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwSubscribe</span><br></pre></td></tr></table></figure><p>app\listener\SwSubscribe.php</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="built_in">declare</span> (strict_types = 1);</span><br><span class="line"></span><br><span class="line">namespace app\listener;</span><br><span class="line"></span><br><span class="line">class SwSubscribe</span><br><span class="line">&#123;</span><br><span class="line">    protected <span class="variable">$ws</span> = null;</span><br><span class="line"></span><br><span class="line">    // public <span class="keyword">function</span> __construct()</span><br><span class="line">    // &#123;</span><br><span class="line">    //     <span class="variable">$this</span>-&gt;ws = app(<span class="string">&#x27;think\swoole\Websocket&#x27;</span>);</span><br><span class="line">    // &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct(\think\Container <span class="variable">$c</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;ws = <span class="variable">$c</span>-&gt;make(\think\swoole\Websocket::class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">onConnect</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$fd</span> = <span class="variable">$this</span>-&gt;ws-&gt;getSender();</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;server: handshake success with fd&#123;<span class="variable">$fd</span>&#125;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">onClose</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$fd</span> = <span class="variable">$this</span>-&gt;ws-&gt;getSender();</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;client &#123;<span class="variable">$fd</span>&#125; closed\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> onMessage(<span class="variable">$event</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$fd</span> = <span class="variable">$this</span>-&gt;ws-&gt;getSender();</span><br><span class="line">        var_dump(<span class="variable">$event</span>);</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;server: handshake success with fd&#123;<span class="variable">$fd</span>&#125;\n&quot;</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;ws-&gt;emit(<span class="string">&quot;this is server&quot;</span>, <span class="variable">$fd</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>有点类似 将原生的swoole代码改成面向对象代码，生效方法 <code>config\swoole.php</code>中在<code>subscribe</code> 加入<code>\app\listener\SwSubscribe::class</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;subscribe&#x27;</span>     =&gt; [</span><br><span class="line"> \app\listener\SwSubscribe::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>在<code>app\event.php</code>文件中的 <code>swoole.websocket.Connect</code> 相当于 <code>app\listener\SwSubscribe.php</code>文件中的<code>onConnect</code>函数。如果同时存在的存在的话，就会向客户端发送2次以上的消息</p></blockquote><h2 id="Task任务投递"><a href="#Task任务投递" class="headerlink" title="Task任务投递"></a>Task任务投递</h2><p><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/start/start_task">https://wiki.swoole.com/#/start/start_task</a></p><p>生成事件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwSendEmailTask</span><br></pre></td></tr></table></figure><p>编写发送邮件方法<code>app\listener\SwSendEmailTask.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump(<span class="variable">$event</span>);</span><br><span class="line">    //</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;开发发送邮件&quot;</span>.<span class="keyword">time</span>();</span><br><span class="line">    <span class="built_in">sleep</span>(3);</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;结束发送邮件&quot;</span>.<span class="keyword">time</span>();</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>注册事件<code>app\event.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;swoole.task&#x27;</span>=&gt;[</span><br><span class="line"> \app\listener\SwSendEmailTask::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>在控制器中投递任务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> <span class="function"><span class="title">doRegister</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$server</span> = app(<span class="string">&#x27;swoole.server&#x27;</span>);</span><br><span class="line">    <span class="variable">$server</span>-&gt;task(\app\listener\SwSendEmailTask::class);</span><br><span class="line">    <span class="built_in">return</span> <span class="string">&quot;注册成功&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> doRegister(\think\swoole\Manager <span class="variable">$manager</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$server</span> = <span class="variable">$manager</span>-&gt;getServer();</span><br><span class="line">    <span class="variable">$server</span>-&gt;task(\app\listener\SwSendEmailTask::class);</span><br><span class="line">    <span class="built_in">return</span> <span class="string">&quot;注册成功&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">function</span> doRegister(\Swoole\Server <span class="variable">$server</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$server</span>-&gt;task(\app\listener\SwSendEmailTask::class);</span><br><span class="line">    <span class="built_in">return</span> <span class="string">&quot;注册成功&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>三种获取<code>\Swoole\Server</code>,任意选其一</p></blockquote><p>在swoole中还有一个事件叫<code>finish</code>，它的作用就是把异步任务的结果返回，在think-swool是这么处理的</p><p>定义一个发送邮件异步任务处理结果的事件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwSendEmailFinish</span><br></pre></td></tr></table></figure><p>注册事件<code>app\event.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;swoole.finish&#x27;</span>=&gt;[</span><br><span class="line"> \app\listener\SwSendEmailFinish::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>在task任务中调用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$event</span>)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump(<span class="variable">$event</span>);</span><br><span class="line">    //</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;开发发送邮件&quot;</span>.<span class="keyword">time</span>();</span><br><span class="line">    <span class="built_in">sleep</span>(3);</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;结束发送邮件&quot;</span>.<span class="keyword">time</span>();</span><br><span class="line">    <span class="variable">$event</span>-&gt;finish(\app\listener\SwSendEmailFinish::class);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h2 id="高性能共享内存-Table"><a href="#高性能共享内存-Table" class="headerlink" title="高性能共享内存 Table"></a>高性能共享内存 Table</h2><p><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/memory/table">https://wiki.swoole.com/#/memory/table</a></p><p>先定结构在进行操作数据（原生swoole操作）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span> = new Swoole\Table(1024);</span><br><span class="line">//创建表</span><br><span class="line"><span class="variable">$table</span>-&gt;column(<span class="string">&quot;id&quot;</span>, Swoole\Table::TYPE_INT);</span><br><span class="line"><span class="variable">$table</span>-&gt;column(<span class="string">&quot;name&quot;</span>, Swoole\Table::TYPE_STRING);</span><br><span class="line"><span class="variable">$table</span>-&gt;column(<span class="string">&quot;money&quot;</span>, Swoole\Table::TYPE_FLOAT);</span><br><span class="line"><span class="variable">$table</span>-&gt;create();</span><br><span class="line"></span><br><span class="line">//添加数据</span><br><span class="line"><span class="variable">$table</span>-&gt;<span class="built_in">set</span>(<span class="string">&quot;zq&quot;</span>, [</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> =&gt; 1,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&quot;zhiqiang&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;money&#x27;</span> =&gt; 100,</span><br><span class="line">]);</span><br><span class="line">//获取一行数据</span><br><span class="line"><span class="variable">$table</span>-&gt;get(<span class="string">&quot;zq&quot;</span>);</span><br><span class="line">// 修改数据</span><br><span class="line">// 字段递增</span><br><span class="line"><span class="variable">$table</span>-&gt;incr(<span class="string">&quot;zq&quot;</span>,<span class="string">&quot;money&quot;</span>,2);</span><br><span class="line">//递减</span><br><span class="line"><span class="variable">$table</span>-&gt;decr(<span class="string">&quot;zq&quot;</span>,<span class="string">&quot;money&quot;</span>,2);</span><br><span class="line">// 返回 table 中存在的条目数。</span><br><span class="line"><span class="variable">$table</span>-&gt;count();</span><br><span class="line">//遍历table中的数据</span><br><span class="line">foreach(<span class="variable">$table</span> as <span class="variable">$item</span>)&#123;</span><br><span class="line">    var_dump(<span class="variable">$item</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>think-swoole中的操作</p><p>先对table表结构进行初始化<code>config\swoole.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;tables&#x27;</span>     =&gt; [</span><br><span class="line">    <span class="string">&#x27;user&#x27;</span>=&gt;[</span><br><span class="line">        <span class="string">&#x27;size&#x27;</span>=&gt;1024,</span><br><span class="line">        <span class="string">&#x27;columns&#x27;</span>=&gt;[</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>=&gt;<span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>=&gt;\Swoole\Table::TYPE_INT</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>=&gt;<span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>=&gt;\Swoole\Table::TYPE_STRING,</span><br><span class="line">                <span class="string">&#x27;size&#x27;</span>=&gt;32</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>=&gt;<span class="string">&#x27;money&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>=&gt;\Swoole\Table::TYPE_FLOAT</span><br><span class="line">            ],</span><br><span class="line"></span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>操作数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span> =  app(<span class="string">&#x27;swoole.table.user&#x27;</span>);</span><br><span class="line"><span class="variable">$table</span>-&gt;<span class="built_in">set</span>(<span class="string">&quot;zq&quot;</span>, [</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> =&gt; 1,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&quot;zhiqiang&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;money&#x27;</span> =&gt; 100</span><br><span class="line">]);</span><br><span class="line">//获取一行数据</span><br><span class="line"><span class="variable">$table</span>-&gt;get(<span class="string">&quot;zq&quot;</span>);</span><br><span class="line">// 修改数据</span><br><span class="line">// 字段递增</span><br><span class="line"><span class="variable">$table</span>-&gt;incr(<span class="string">&quot;zq&quot;</span>, <span class="string">&quot;money&quot;</span>, 2);</span><br><span class="line">//递减</span><br><span class="line"><span class="variable">$table</span>-&gt;decr(<span class="string">&quot;zq&quot;</span>, <span class="string">&quot;money&quot;</span>, 2);</span><br><span class="line">// 返回 table 中存在的条目数。</span><br><span class="line"><span class="variable">$table</span>-&gt;count();</span><br><span class="line">//遍历table中的数据</span><br><span class="line">foreach (<span class="variable">$table</span> as <span class="variable">$item</span>) &#123;</span><br><span class="line">var_dump(<span class="variable">$item</span>);</span><br><span class="line">&#125;</span><br><span class="line">// 检查 table 中是否存在某一个 key。</span><br><span class="line"><span class="variable">$table</span>-&gt;exist(<span class="string">&#x27;zq&#x27;</span>);</span><br><span class="line">//获取实际占用内存尺寸,单位字节</span><br><span class="line"><span class="variable">$table</span>-&gt;momorySize();</span><br></pre></td></tr></table></figure><h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>RPC(Remote Procedure Call)：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的思想。</p><p>详细介绍：<a target="_blank" rel="noopener" href="https://developer.51cto.com/art/201906/597963.htm">https://developer.51cto.com/art/201906/597963.htm</a></p><ul><li>解决分布式系统中，服务之间的调用问题。</li><li>远程调用时，要能够像本地调用一样方便，让调用者感知不到远程调用的逻辑。</li><li>节点角色说明：</li><li>Server: 暴露服务的服务提供方</li><li>Client: 调用远程服务的服务消费方</li><li>Registry: 服务注册与发现的注册中心</li></ul><p>think-swoole实现RPC功能</p><h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><h4 id="接口定义app-rpc-interfaces-UserInterface-php"><a href="#接口定义app-rpc-interfaces-UserInterface-php" class="headerlink" title="接口定义app/rpc/interfaces/UserInterface.php"></a>接口定义<code>app/rpc/interfaces/UserInterface.php</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\rpc\interfaces;</span><br><span class="line">interface UserInterface</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="keyword">function</span> create();</span><br><span class="line">    public <span class="keyword">function</span> find(int <span class="variable">$id</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现接口app-rpc-services-UserService-php"><a href="#实现接口app-rpc-services-UserService-php" class="headerlink" title="实现接口app/rpc/services/UserService.php"></a>实现接口<code>app/rpc/services/UserService.php</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\rpc\services;</span><br><span class="line">use app\rpc\interfaces\UserInterface;</span><br><span class="line">class UserService implements UserInterface</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">create</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">        // TODO: Implement create() method.</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;service create success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> find(int <span class="variable">$id</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        // TODO: Implement find() method.</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$id</span>. <span class="string">&quot;查询数据遍历&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="注册rpc服务config-swoole-php"><a href="#注册rpc服务config-swoole-php" class="headerlink" title="注册rpc服务config/swoole.php"></a>注册rpc服务<code>config/swoole.php</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;rpc&#x27;</span>        =&gt; [</span><br><span class="line">    <span class="string">&#x27;server&#x27;</span> =&gt; [</span><br><span class="line">     //开启rpc服务</span><br><span class="line">        <span class="string">&#x27;enable&#x27;</span>   =&gt; <span class="literal">true</span>,</span><br><span class="line">        //rpc端口</span><br><span class="line">        <span class="string">&#x27;port&#x27;</span>     =&gt; 9000,</span><br><span class="line">        <span class="string">&#x27;services&#x27;</span> =&gt; [</span><br><span class="line">         //注册服务</span><br><span class="line">            \app\rpc\services\UserService::class</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    // 如果填写也是可以调用其他服务端</span><br><span class="line">    <span class="string">&#x27;client&#x27;</span> =&gt; [</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>启动服务端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think swoole start /  php think swoole:rpc</span><br></pre></td></tr></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;rpc&#x27;</span>        =&gt; [</span><br><span class="line">    <span class="string">&#x27;server&#x27;</span> =&gt; [</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;client&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;tp6&#x27;</span>=&gt;[</span><br><span class="line">         //服务端的ip地址</span><br><span class="line">            <span class="string">&#x27;host&#x27;</span>=&gt;<span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">            //服务端对应的端口</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span>=&gt;<span class="string">&#x27;9000&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">        // 更多服务端</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>运行<code>php think rpc:interface</code>生成RPC接口文件<code>app\rpc.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * This file is auto-generated.</span><br><span class="line"> */</span><br><span class="line"><span class="built_in">declare</span>(strict_types=1);</span><br><span class="line">namespace rpc\contract\tp6;</span><br><span class="line">interface UserInterface</span><br><span class="line">&#123;</span><br><span class="line"> public <span class="keyword">function</span> create();</span><br><span class="line"> public <span class="keyword">function</span> find(int <span class="variable">$id</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">return</span> [<span class="string">&#x27;tp6&#x27;</span> =&gt; [<span class="string">&#x27;rpc\contract\tp6\UserInterface&#x27;</span>]];</span><br></pre></td></tr></table></figure><p>在控制器调用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    public <span class="keyword">function</span> index(\rpc\contract\tp6\UserInterface <span class="variable">$user</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        //</span><br><span class="line">        <span class="variable">$user</span>-&gt;find(1);</span><br><span class="line">//        <span class="variable">$user</span>-&gt;create();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h2><p>在think-swoole 2.0版本的时候还是支持自定义定时任务配置,详细参考<a target="_blank" rel="noopener" href="https://github.com/top-think/think-swoole/tree/2.0">https://github.com/top-think/think-swoole/tree/2.0</a></p><p>在3.0就不支持了，在这里介绍一个通用的命令行启动定时任务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:<span class="built_in">command</span> SwooleTimer</span><br></pre></td></tr></table></figure><p>加载命令行<code>config/console.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;commands&#x27;</span> =&gt; [</span><br><span class="line"> <span class="string">&#x27;swooletimer&#x27;</span>=&gt;app\<span class="built_in">command</span>\SwooleTimer::class</span><br><span class="line"> ...........</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>书写命令脚本<code>app/command/SwooleTimer.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="built_in">declare</span> (strict_types = 1);</span><br><span class="line"></span><br><span class="line">namespace app\<span class="built_in">command</span>;</span><br><span class="line"></span><br><span class="line">use think\console\Command;</span><br><span class="line">use think\console\input\Argument;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class SwooleTimer extends Command</span><br><span class="line">&#123;</span><br><span class="line">    protected <span class="keyword">function</span> <span class="function"><span class="title">configure</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">        // 指令配置</span><br><span class="line">        <span class="variable">$this</span>-&gt;setName(<span class="string">&#x27;app\command\swooletimer&#x27;</span>)</span><br><span class="line">            -&gt;addArgument(<span class="string">&#x27;action&#x27;</span>, Argument::OPTIONAL, <span class="string">&quot;start | stop&quot;</span>, <span class="string">&#x27;start&#x27;</span>)</span><br><span class="line">            -&gt;setDescription(<span class="string">&#x27;Swoole Timer for ThinkPHP&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">handle</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$action</span> = <span class="variable">$this</span>-&gt;input-&gt;getArgument(<span class="string">&#x27;action&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$action</span>, [<span class="string">&#x27;start&#x27;</span>,<span class="string">&#x27;stopall&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;app-&gt;invokeMethod([<span class="variable">$this</span>, <span class="variable">$action</span>], [], <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;output-&gt;writeln(<span class="string">&quot;&lt;error&gt;Invalid argument action:&#123;<span class="variable">$action</span>&#125;, Expected start&lt;/error&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 启动定时任务 主要任务计划在这里书写</span><br><span class="line">     */</span><br><span class="line">    protected <span class="keyword">function</span> <span class="function"><span class="title">start</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">        // https://wiki.swoole.com/#/timer</span><br><span class="line">        <span class="variable">$timer_id</span>=swoole_timer_tick(2000,<span class="function"><span class="title">function</span></span> ()&#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;2s循环执行需要做的事情&quot;</span>.<span class="keyword">time</span>().<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable">$this</span>-&gt;output-&gt;writeln(<span class="string">&quot;Swoole Timer_id:&#123;<span class="variable">$timer_id</span>&#125; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 清除所有的定时任务</span><br><span class="line">     */</span><br><span class="line">    protected  <span class="keyword">function</span> <span class="function"><span class="title">stop</span></span>()&#123;</span><br><span class="line">        swoole_timer_clear_all();</span><br><span class="line">        <span class="variable">$this</span>-&gt;output-&gt;writeln(<span class="string">&quot;Swoole Timer  clear all ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><footer class="bg-gradient-to-r from-purple-700 to-blue-600 text-white py-8 mt-auto"><div class="container mx-auto px-4"><div class="flex flex-col md:flex-row md:justify-between md:items-start space-y-6 md:space-y-0"><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">志强vlog</h3><p class="text-sm opacity-80">感谢您的访问！这里是 王志强 专属博客，分享生活与技术。</p></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">快捷导航</h3><ul class="space-y-2 text-sm opacity-90"><li><a href="/" class="hover:text-yellow-300 transition">Home</a></li><li><a href="/archives" class="hover:text-yellow-300 transition">Archives</a></li><li><a href="/resources" class="hover:text-yellow-300 transition">Rsources</a></li><li><a href="/tags" class="hover:text-yellow-300 transition">Tags</a></li><li><a href="/about" class="hover:text-yellow-300 transition">About</a></li><li><a href="/sitemap.xml" class="hover:text-yellow-300 transition">RSS</a></li></ul></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">友情链接</h3><ul class="space-y-2 text-sm opacity-90"><li><a href="https://cnb.cool/zhiqiangwang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">CNB</a></li><li><a href="https://github.com/chihqiang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">GitHub</a></li><li><a href="https://www.zhiqiang.wang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">志强vlog</a></li></ul></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">联系方式</h3><p class="text-sm opacity-80 flex items-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-18 8h18a2 2 0 002-2V8a2 2 0 00-2-2H3a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg> <a href="mailto:zhiqiang2033@gmail.com" class="hover:text-yellow-300">zhiqiang2033@gmail.com</a></p><p class="text-sm opacity-80 flex items-center space-x-2 mt-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 21s8-4.5 8-10a8 8 0 10-16 0c0 5.5 8 10 8 10z"/></svg> <span>中国</span></p></div></div><hr class="my-6 border-purple-400 opacity-50"><p class="text-center text-sm opacity-70 mb-2">© 2024 志强vlog. 保留所有权利.</p><p class="text-center text-xs opacity-50">由 <a href="https://hexo.io/" target="_blank" rel="noopener" class="underline hover:text-yellow-300">Hexo</a> 驱动，主题由 <a href="https://github.com/chihqiang/hexo-theme-tailog" target="_blank" rel="noopener" class="underline hover:text-yellow-300">hexo-theme-tailog</a> 提供。</p></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-TBH6G20B8Y"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TBH6G20B8Y")</script></footer><button id="back-to-top" class="fixed bottom-8 right-8 bg-gradient-to-r from-purple-500 to-blue-500 text-white p-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 opacity-0 invisible z-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg></button></body></html>