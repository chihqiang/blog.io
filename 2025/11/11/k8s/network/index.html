<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>探秘 K8s Pod 网络：从原理到实战 | 志强vlog</title><meta name="keywords" content="kubernetes"><meta name="description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta property="og:type" content="article"><meta property="og:title" content="探秘 K8s Pod 网络：从原理到实战 | 志强vlog"><meta property="og:description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta property="og:url" content="https://www.zhiqiang.wang/2025/11/11/k8s/network/"><meta property="og:image" content="/img/favicon.ico"><meta property="og:site_name" content="志强vlog"><meta property="article:published_time" content="Tue Nov 11 2025 22:55:42 GMT+0800"><meta property="article:author" content="王志强"><meta property="article:tag" content="kubernetes"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="探秘 K8s Pod 网络：从原理到实战 | 志强vlog"><meta name="twitter:description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta name="twitter:image" content="/img/favicon.ico"><script type="application/ld+json">{
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "探秘 K8s Pod 网络：从原理到实战",
      "image": "/img/favicon.ico",
      "author": {
        "@type": "Person",
        "name": "王志强"
      },
      "datePublished": "Tue Nov 11 2025 22:55:42 GMT+0800",
      "dateModified": "Thu Jan 08 2026 06:03:16 GMT+0000",
      "description": "志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"
    }</script><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"><script>"dark"===localStorage.getItem("theme")||!localStorage.getItem("theme")&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><script src="https://cdn.tailwindcss.com/3.4.16"></script><script>tailwind.config={darkMode:"class",theme:{extend:{}}}</script><script src="https://unpkg.com/alpinejs@3.14.9/dist/cdn.min.js" defer></script><link rel="stylesheet" href="/css/blog.css"><script src="/js/blog.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body class="bg-gradient-to-br from-purple-100 to-blue-100 dark:from-gray-900 dark:to-gray-800 min-h-screen flex flex-col transition-colors duration-300"><nav id="navbar" class="bg-gradient-to-r from-purple-600 to-blue-500 shadow-lg dark:from-gray-800 dark:to-gray-700 transition-all duration-300 sticky top-0 z-40"><div class="container mx-auto px-4 py-3"><div class="flex justify-between items-center"><h1 class="text-white text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-pink-400"><a href="/">志强vlog</a></h1><div id="desktop-menu" class="hidden lg:flex items-center space-x-1"><a href="/" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="0">Home </a><a href="/archives" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="1">Archives </a><a href="/resources" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="2">Rsources </a><a href="/tags" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="3">Tags </a><a href="/about" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="4">About </a><a href="/sitemap.xml" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="5">RSS</a><div id="dropdown-menu" class="relative group hidden"><button class="text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10 flex items-center">更多 <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="dropdown-content" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0"></div></div></div><div class="flex items-center space-x-1 sm:space-x-2"><button id="searchButton" class="p-2 sm:p-2.5 rounded-full bg-white/20 hover:bg-white/30 transition-all duration-300 text-white hover:scale-110 active:scale-95" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button> <button id="theme-toggle" class="p-2 sm:p-2.5 rounded-full bg-white/20 hover:bg-white/30 transition-all duration-300 text-white hover:scale-110 active:scale-95" aria-label="切换主题"><svg id="sun-icon" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg> <svg id="moon-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg></button> <button id="mobile-menu-button" aria-label="切换菜单" class="lg:hidden p-2 sm:p-2.5 rounded-lg hover:bg-white/10 transition-all duration-300 text-white hover:scale-110 active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div></div></div><div id="mobile-menu" class="lg:hidden hidden bg-gradient-to-r from-purple-600 to-blue-500 dark:from-gray-800 dark:to-gray-700 px-4 pb-4 transition-all duration-300"><div class="space-y-1"><a href="/" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Home</span> </a><a href="/archives" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Archives</span> </a><a href="/resources" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Rsources</span> </a><a href="/tags" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Tags</span> </a><a href="/about" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">About</span> </a><a href="/sitemap.xml" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">RSS</span></a></div></div></nav><div id="searchOverlay" class="overlay hidden"></div><div id="inputContainer" class="floating-search hidden"><input type="text" id="inputField" placeholder="搜索文章..." class="search-input" autocomplete="off"><div id="articleList" class="search-results"></div></div><script>document.addEventListener("DOMContentLoaded",DOMContentLoadedSearch)</script><div id="reading-progress" class="fixed top-0 left-0 h-1 bg-gradient-to-r from-purple-500 to-blue-500 z-50 transition-all duration-150" style="width:0%"></div><div class="container mx-auto px-4 py-8"><article class="bg-white p-6 sm:p-8 rounded-xl shadow-lg transition hover:scale-[1.01] max-w-5xl mx-auto mt-8"><header class="mb-6 sm:mb-8"><h1 class="text-3xl sm:text-4xl font-bold mb-3 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">探秘 K8s Pod 网络：从原理到实战</h1><div class="flex flex-wrap items-center text-gray-500 text-sm space-x-4"><span>2025-11-11</span> <span><a href="/categories/%E8%BF%90%E7%BB%B4/" class="text-blue-600 hover:underline">运维</a> </span><span><a href="/tags/kubernetes/" class="text-blue-600 hover:underline">kubernetes</a></span></div></header><div class="article-content prose prose-base lg:prose-lg max-w-none"><p>在 Kubernetes（简称 K8s）生态中，Pod 作为最小部署单元，是容器运行的载体，而 Pod 网络则是维系整个集群通信的 “神经网络”。无论是同一节点上的 Pod 互通、跨节点 Pod 协作，还是集群内外服务的连接，都依赖稳定、高效的 Pod 网络机制。如果说 K8s 是云原生应用的 “操作系统”，那么 Pod 网络就是这套系统的 “通信总线”—— 没有可靠的网络，容器化应用的分布式部署、弹性伸缩等核心优势都无从谈起。</p><p>本文将从 Pod 网络的基础类型切入，深入剖析其工作原理，对比主流网络插件，详解 DNS 服务配置、网络安全策略，结合实战排查技巧与案例，帮助读者全面掌握 K8s Pod 网络的核心知识与实践方法。</p><h2 id="Pod-网络类型全解析"><a href="#Pod-网络类型全解析" class="headerlink" title="Pod 网络类型全解析"></a>Pod 网络类型全解析</h2><h3 id="容器内部网络"><a href="#容器内部网络" class="headerlink" title="容器内部网络"></a>容器内部网络</h3><p>同一 Pod 中的多个容器共享一个网络命名空间（Network Namespace），这是 K8s Pod 网络最基础的特性。这意味着它们拥有相同的 IP 地址、端口空间、路由表和 DNS 配置，容器之间可以通过 <code>localhost</code> 直接通信，无需额外的网络转发或端口映射。</p><p><strong>优势</strong>：</p><ol><li>通信效率极高，无需跨网络命名空间的转发开销；</li><li>配置简单，容器间可直接复用端口（只要不冲突），无需考虑端口暴露；</li><li>数据隔离性强，同一 Pod 内的容器共享网络栈，数据传输无需经过外部网络。</li></ol><p><strong>典型场景</strong>：Pod 中的 “主容器” 负责业务逻辑，“边车容器”（Sidecar）负责日志收集、监控代理、服务网格代理（如 Istio）等，边车容器通过 <code>localhost</code> 与主容器通信，无需暴露额外端口。</p><h3 id="Pod-之间网络"><a href="#Pod-之间网络" class="headerlink" title="Pod 之间网络"></a>Pod 之间网络</h3><p>不同 Pod 之间的通信是 K8s 集群网络的核心场景，无论是同一节点上的 Pod，还是跨节点的 Pod，都需要通过统一的网络方案实现互通。K8s 本身没有内置网络实现，而是通过 CNI（Container Network Interface，容器网络接口）规范对接第三方网络插件，常见的有 Flannel、Calico 等。</p><h4 id="核心原则"><a href="#核心原则" class="headerlink" title="核心原则"></a>核心原则</h4><p>K8s 要求所有 Pod 都拥有独立的、可路由的 IP 地址，且 Pod 之间无需 NAT（网络地址转换）即可直接通信，即 “Pod IP 全局可达”。</p><h4 id="实战示例：Flannel-插件实现跨节点通信"><a href="#实战示例：Flannel-插件实现跨节点通信" class="headerlink" title="实战示例：Flannel 插件实现跨节点通信"></a>实战示例：Flannel 插件实现跨节点通信</h4><p>Flannel 是最常用的轻量级 CNI 插件，通过在集群中分配独立的子网给每个节点，实现跨节点 Pod 通信，其核心原理是 “Overlay 网络”（覆盖网络），常用 VXLAN 模式转发流量。</p><p><strong>1. 安装 Flannel</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 Flannel 配置文件（适配 K8s 1.24+）</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/v0.22.3/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p><strong>2. 工作流程</strong></p><ul><li>集群初始化时，Flannel 会为每个节点分配一个独立的子网（如节点 A 分配 <code>10.244.0.0/24</code>，节点 B 分配 <code>10.244.1.0/24</code>）；</li><li>同一节点上的 Pod 属于同一子网，通过节点内部的网桥（如 <code>cni0</code>）直接通信；</li><li>跨节点 Pod 通信时（如节点 A 的 Pod<code>10.244.0.10</code>访问节点 B 的 Pod<code>10.244.1.10</code>）：<ol><li>流量从 Pod 流出，经过节点的 <code>cni0</code> 网桥转发到 Flannel 守护进程（<code>flanneld</code>）；</li><li><code>flanneld</code> 通过 VXLAN 隧道将流量封装，发送到目标节点；</li><li>目标节点的 <code>flanneld</code> 解封装流量，转发到目标 Pod 所在的 <code>cni0</code> 网桥，最终送达目标 Pod。</li></ol></li></ul><h3 id="集群内部网络"><a href="#集群内部网络" class="headerlink" title="集群内部网络"></a>集群内部网络</h3><p>Pod 的 IP 地址是动态变化的（如 Pod 重启、重建后 IP 会改变），直接通过 Pod IP 访问服务会导致 “服务不可用”。K8s 提供 <code>Service</code> 资源，为一组 Pod 提供固定的访问入口（ClusterIP），并通过标签选择器（Label Selector）自动关联 Pod，实现负载均衡和服务发现。</p><h4 id="核心作用"><a href="#核心作用" class="headerlink" title="核心作用"></a>核心作用</h4><ol><li>固定访问地址：Service 分配的 ClusterIP 是集群内部固定的虚拟 IP，不会随 Pod 变化；</li><li>负载均衡：自动将请求分发到关联的多个 Pod 上，提高服务可用性；</li><li>服务发现：通过 Service 名称，集群内的 Pod 可直接访问目标服务，无需记忆 Pod IP。</li></ol><h4 id="配置示例：创建-ClusterIP-Service"><a href="#配置示例：创建-ClusterIP-Service" class="headerlink" title="配置示例：创建 ClusterIP Service"></a>配置示例：创建 ClusterIP Service</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span>  <span class="comment"># Service 名称（用于 DNS 解析）</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-app</span>     <span class="comment"># 关联标签为 app=my-app 的 Pod</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>        <span class="comment"># Service 暴露的端口（集群内部访问端口）</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># Pod 实际监听的端口</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>   <span class="comment"># 集群内部访问类型（默认）</span></span><br></pre></td></tr></table></figure><p><strong>应用场景</strong>：集群内的微服务通信（如订单服务访问支付服务），通过 Service 名称即可实现稳定访问，无需关注 Pod IP 的动态变化。</p><h3 id="集群外部网络"><a href="#集群外部网络" class="headerlink" title="集群外部网络"></a>集群外部网络</h3><p>默认情况下，Service 和 Pod 仅能在集群内部访问，若需让外部用户或应用访问集群内的服务，K8s 提供了 3 种主流方案：</p><h4 id="1-NodePort"><a href="#1-NodePort" class="headerlink" title="1. NodePort"></a>1. NodePort</h4><p>在每个节点上开放一个静态端口（NodePort），外部流量通过 <code>节点 IP:NodePort</code> 访问集群内的 Service。</p><p><strong>配置示例</strong>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>        <span class="comment"># Service 内部端口</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># Pod 端口</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30007</span>  <span class="comment"># 自定义 NodePort（范围：30000-32767，可选）</span></span><br></pre></td></tr></table></figure><p><strong>优势</strong>：配置简单，无需额外依赖；<strong>缺点</strong>：端口范围有限，暴露节点 IP，扩展性差。</p><h4 id="2-LoadBalancer"><a href="#2-LoadBalancer" class="headerlink" title="2. LoadBalancer"></a>2. LoadBalancer</h4><p>依赖云厂商的负载均衡服务（如 AWS ELB、阿里云 SLB），自动创建负载均衡器并关联节点，外部流量通过负载均衡器 IP 访问服务。</p><p><strong>配置示例</strong>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p><strong>优势</strong>：自动负载均衡，高可用，扩展性好；<strong>缺点</strong>：依赖云厂商，可能产生额外费用。</p><h4 id="3-Ingress"><a href="#3-Ingress" class="headerlink" title="3. Ingress"></a>3. Ingress</h4><p>Ingress 是集群的 “入口网关”，通过统一的域名和路径规则，将外部流量路由到不同的 Service，支持 HTTPS、路径重写、负载均衡等高级功能，是生产环境中暴露服务的首选方案。</p><p><strong>配置示例</strong>（需先安装 Ingress Controller，如 Nginx Ingress）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">app.example.com</span>  <span class="comment"># 外部访问域名</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">my-service</span>  <span class="comment"># 关联的 Service 名称</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p><strong>优势</strong>：</p><ul><li>统一入口，支持多域名、多路径路由；</li><li>支持 HTTPS 终结、SSL 证书管理；</li><li>无需暴露节点 IP 或静态端口，安全性更高。</li></ul><h2 id="Pod-网络工作原理深度剖析"><a href="#Pod-网络工作原理深度剖析" class="headerlink" title="Pod 网络工作原理深度剖析"></a>Pod 网络工作原理深度剖析</h2><h3 id="Pod-网络创建流程"><a href="#Pod-网络创建流程" class="headerlink" title="Pod 网络创建流程"></a>Pod 网络创建流程</h3><p>Pod 的网络命名空间和网络配置，是通过 K8s 组件与 CNI 插件协同完成的，完整流程如下：</p><ol><li><p><strong>用户提交 Pod 请求</strong>：通过 <code>kubectl apply -f pod.yaml</code> 提交 Pod 配置，API Server 接收请求并存储到 etcd；</p></li><li><p><strong>调度器分配节点</strong>：调度器（kube-scheduler）根据节点资源、亲和性等规则，为 Pod 选择合适的节点，并将节点信息更新到 etcd；</p></li><li><p><strong>Kubelet 启动 Pod</strong>：目标节点的 Kubelet 组件监听 API Server，发现新的 Pod 调度到本节点后，调用容器运行时（如 containerd）创建 Pod 的网络命名空间；</p></li><li><p>CNI 插件配置网络</p><p>：Kubelet 调用 CNI 插件（如 Flannel），执行以下操作：</p><ul><li>为 Pod 分配独立的 IP 地址（从节点子网中分配）；</li><li>配置 Pod 的网络接口（如 <code>eth0</code>），并连接到节点的网桥（如 <code>cni0</code>）；</li><li>设置路由规则，确保 Pod 能访问集群内其他 Pod 和外部网络；</li></ul></li><li><p><strong>网络就绪</strong>：Pod 网络配置完成后，Kubelet 标记 Pod 为 “Running” 状态，此时 Pod 可正常通信。</p></li></ol><h3 id="网络通信机制（以-Flannel-VXLAN-模式为例）"><a href="#网络通信机制（以-Flannel-VXLAN-模式为例）" class="headerlink" title="网络通信机制（以 Flannel VXLAN 模式为例）"></a>网络通信机制（以 Flannel VXLAN 模式为例）</h3><p>以 “节点 A 的 Pod A（IP：10.244.0.10）访问节点 B 的 Pod B（IP：10.244.1.10）” 为例，详细拆解流量转发流程：</p><ol><li><strong>Pod A 发起请求</strong>：Pod A 中的应用发起 TCP 连接请求（目标 IP：10.244.1.10，目标端口：8080）；</li><li><strong>Pod 内部路由</strong>：由于 Pod 网络命名空间已配置路由规则，流量从 Pod A 的 <code>eth0</code> 接口流出；</li><li><strong>节点网桥转发</strong>：流量到达节点 A 的 <code>cni0</code> 网桥（<code>cni0</code> 是 Pod 与节点网络的桥梁）；</li><li><strong>Flannel 封装流量</strong>：节点 A 的 <code>flanneld</code> 进程监听 <code>cni0</code> 网桥，识别到目标 IP 属于节点 B 的子网，将原始 IP 数据包封装为 VXLAN 数据包（外层 IP 为节点 A 和节点 B 的物理 IP）；</li><li><strong>跨节点传输</strong>：VXLAN 数据包通过节点的物理网卡发送，经过集群网络（如交换机、路由器）传输到节点 B；</li><li><strong>Flannel 解封装流量</strong>：节点 B 的 <code>flanneld</code> 进程接收 VXLAN 数据包，解封装得到原始 IP 数据包；</li><li><strong>目标节点转发</strong>：节点 B 的 <code>flanneld</code> 将原始数据包转发到 <code>cni0</code> 网桥，再由网桥转发到 Pod B 的 <code>eth0</code> 接口；</li><li><strong>Pod B 接收请求</strong>：Pod B 中的应用监听 <code>8080</code> 端口，接收并处理请求。</li></ol><h2 id="主流网络插件对比与选择"><a href="#主流网络插件对比与选择" class="headerlink" title="主流网络插件对比与选择"></a>主流网络插件对比与选择</h2><p>K8s 支持多种 CNI 插件，不同插件在性能、功能、适用场景上存在差异，以下是主流插件的对比与选择建议：</p><h3 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h3><ul><li><p><strong>核心特点</strong>：轻量级、配置简单、无状态，支持 VXLAN、Host-GW 等模式；</p></li><li><p><strong>工作原理</strong>：为每个节点分配独立子网，通过 Overlay 网络或路由转发实现 Pod 互通；</p></li><li><p><strong>优势</strong>：部署成本低，适合中小型集群、测试环境或对网络性能要求不高的场景；</p></li><li><p><strong>劣势</strong>：VXLAN 模式存在封装开销，性能略低于 Calico；不支持网络策略（NetworkPolicy）；</p></li><li><p>配置建议</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用 Host-GW 模式（无封装开销，性能更好，要求节点之间能直接通信）</span></span><br><span class="line">kubectl edit configmap kube-flannel-cfg -n kube-system</span><br><span class="line"><span class="comment"># 修改 net-conf.json 中的 &quot;Type&quot; 为 &quot;host-gw&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h3><ul><li><strong>核心特点</strong>：高性能、功能丰富，支持 BGP 路由协议、网络策略、加密通信等；</li><li><strong>工作原理</strong>：基于 BGP 协议在节点之间分发路由信息，Pod 之间通过路由直接通信，无需 Overlay 封装（默认模式）；</li><li>优势：<ol><li>性能优异，无 VXLAN 封装开销，适合大型集群、高性能场景；</li><li>支持细粒度的网络策略（NetworkPolicy），可控制 Pod 之间的访问权限；</li><li>支持网络加密（IPsec）、Pod 移动性、带宽管理等高级功能；</li></ol></li><li><strong>劣势</strong>：配置相对复杂，需要理解 BGP 路由基础；</li><li><strong>典型场景</strong>：生产环境、大型集群、对网络性能和安全性有较高要求的场景（如金融、电商系统）。</li></ul><h3 id="其他插件"><a href="#其他插件" class="headerlink" title="其他插件"></a>其他插件</h3><ul><li><strong>Weave Net</strong>：支持自动网络配置，无需预先规划子网，支持加密通信和网络策略，适合快速部署的中小型集群；</li><li><strong>Cilium</strong>：基于 eBPF 技术，性能远超传统插件，支持高级网络策略、可观测性，适合对性能和功能有极致要求的场景（如服务网格、边缘计算）；</li><li><strong>Canal</strong>：结合 Flannel 的简单性和 Calico 的网络策略，适合需要网络策略但不想复杂配置的场景。</li></ul><h3 id="选择建议"><a href="#选择建议" class="headerlink" title="选择建议"></a>选择建议</h3><table><thead><tr><th>场景</th><th>推荐插件</th></tr></thead><tbody><tr><td>测试环境、小型集群</td><td>Flannel</td></tr><tr><td>生产环境、大型集群</td><td>Calico&#x2F;Cilium</td></tr><tr><td>需要网络策略</td><td>Calico&#x2F;Cilium&#x2F;Weave Net</td></tr><tr><td>极致性能要求</td><td>Calico（BGP 模式）&#x2F;Cilium</td></tr><tr><td>快速部署、自动配置</td><td>Weave Net</td></tr></tbody></table><h2 id="网络策略与安全保障"><a href="#网络策略与安全保障" class="headerlink" title="网络策略与安全保障"></a>网络策略与安全保障</h2><p>在多租户集群或复杂微服务架构中，需要限制 Pod 之间的访问权限（如只允许订单服务访问支付服务，拒绝其他服务访问），K8s 的 <code>NetworkPolicy</code> 资源可实现细粒度的网络访问控制。</p><h3 id="NetworkPolicy-详解"><a href="#NetworkPolicy-详解" class="headerlink" title="NetworkPolicy 详解"></a>NetworkPolicy 详解</h3><p>NetworkPolicy 是 K8s 中的网络安全规则，用于定义 “哪些 Pod 可以被哪些来源（Pod、IP、端口）访问”，或 “哪些 Pod 可以访问哪些目标”，仅对匹配标签的 Pod 生效。</p><h4 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h4><ul><li><strong>Pod 选择器（podSelector）</strong>：指定规则作用于哪些 Pod（通过标签匹配）；</li><li><strong>入站规则（ingress）</strong>：允许哪些来源的流量访问目标 Pod；</li><li><strong>出站规则（egress）</strong>：允许目标 Pod 访问哪些目的地；</li><li><strong>规则匹配条件</strong>：可通过 IP 段（ipBlock）、Pod 标签（podSelector）、命名空间（namespaceSelector）、端口（ports）过滤流量。</li></ul><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>NetworkPolicy 仅对支持的 CNI 插件生效（如 Calico、Cilium、Weave Net），Flannel 不支持；</li><li>默认情况下，没有 NetworkPolicy 时，所有 Pod 之间可自由通信；一旦创建了针对某个 Pod 的 NetworkPolicy，未被规则允许的流量将被拒绝。</li></ul><h3 id="实战场景应用"><a href="#实战场景应用" class="headerlink" title="实战场景应用"></a>实战场景应用</h3><h4 id="场景-1：限制仅指定-Pod-可访问支付服务"><a href="#场景-1：限制仅指定-Pod-可访问支付服务" class="headerlink" title="场景 1：限制仅指定 Pod 可访问支付服务"></a>场景 1：限制仅指定 Pod 可访问支付服务</h4><p>假设支付服务的 Pod 标签为 <code>app=payment</code>，仅允许标签为 <code>app=order</code> 的订单服务 Pod 访问其 <code>8080</code> 端口。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># networkpolicy-payment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">payment-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">payment</span>  <span class="comment"># 作用于支付服务 Pod</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span>  <span class="comment"># 仅配置入站规则</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">order</span>  <span class="comment"># 允许订单服务 Pod 访问</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span>  <span class="comment"># 仅允许访问 8080 端口</span></span><br></pre></td></tr></table></figure><h4 id="场景-2：限制-Pod-仅能访问内部服务和-DNS"><a href="#场景-2：限制-Pod-仅能访问内部服务和-DNS" class="headerlink" title="场景 2：限制 Pod 仅能访问内部服务和 DNS"></a>场景 2：限制 Pod 仅能访问内部服务和 DNS</h4><p>假设应用 Pod 标签为 <code>app=web</code>，仅允许其访问集群内 <code>app=api</code> 的服务（<code>80</code> 端口），以及 DNS 服务（<code>53</code> 端口，用于域名解析）。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># networkpolicy-web.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span>  <span class="comment"># 配置出站规则</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="comment"># 允许访问 api 服务</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">api</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># 允许访问 DNS 服务（集群 DNS 服务 IP 通常为 10.96.0.10）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span><span class="string">/32</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">53</span></span><br></pre></td></tr></table></figure><h2 id="K8s-DNS-服务：从-IP-访问到域名解析"><a href="#K8s-DNS-服务：从-IP-访问到域名解析" class="headerlink" title="K8s DNS 服务：从 IP 访问到域名解析"></a>K8s DNS 服务：从 IP 访问到域名解析</h2><p>在 K8s 集群中，直接使用 Pod IP 或 Service ClusterIP 访问服务存在明显缺陷：Pod IP 动态变化、ClusterIP 是虚拟 IP 难以记忆。K8s 内置的 DNS 服务（核心组件为 CoreDNS）解决了这一问题，为 Pod、Service 提供了域名解析能力，让集群内的服务可通过 “名称” 实现通信，无需关注底层 IP。</p><h3 id="一、K8s-DNS-核心组件：CoreDNS"><a href="#一、K8s-DNS-核心组件：CoreDNS" class="headerlink" title="一、K8s DNS 核心组件：CoreDNS"></a>一、K8s DNS 核心组件：CoreDNS</h3><p>CoreDNS 是 K8s 1.13+ 版本的默认 DNS 服务器，替代了早期的 kube-dns。它以 Pod 形式运行在 <code>kube-system</code> 命名空间，通过 Service（<code>kube-dns</code>，ClusterIP 通常为 <code>10.96.0.10</code>）暴露服务，所有 Pod 会自动配置该 DNS 服务器作为默认 DNS 解析器。</p><h4 id="1-查看-CoreDNS-状态"><a href="#1-查看-CoreDNS-状态" class="headerlink" title="1. 查看 CoreDNS 状态"></a>1. 查看 CoreDNS 状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 CoreDNS Pod</span></span><br><span class="line">kubectl get pods -n kube-system -l k8s-app=kube-dns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 kube-dns Service（DNS 服务入口）</span></span><br><span class="line">kubectl get svc kube-dns -n kube-system</span><br><span class="line"><span class="comment"># 输出示例：</span></span><br><span class="line"><span class="comment"># NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span></span><br><span class="line"><span class="comment"># kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP   30d</span></span><br></pre></td></tr></table></figure><h4 id="2-CoreDNS-核心功能"><a href="#2-CoreDNS-核心功能" class="headerlink" title="2. CoreDNS 核心功能"></a>2. CoreDNS 核心功能</h4><ul><li>为 Service 自动创建域名，支持集群内解析；</li><li>为 Pod 提供可选的域名解析（需配置 <code>hostname</code> 和 <code>subdomain</code>）；</li><li>支持自定义 DNS 配置（如转发外部域名、自定义域名映射）；</li><li>支持 DNS 缓存，提升解析性能。</li></ul><h3 id="二、K8s-DNS-解析规则：3-类核心域名"><a href="#二、K8s-DNS-解析规则：3-类核心域名" class="headerlink" title="二、K8s DNS 解析规则：3 类核心域名"></a>二、K8s DNS 解析规则：3 类核心域名</h3><p>K8s 为不同资源定义了标准化的 DNS 域名格式，确保解析的唯一性和可用性，核心分为 3 类：</p><h4 id="1-Service-域名（最常用）"><a href="#1-Service-域名（最常用）" class="headerlink" title="1. Service 域名（最常用）"></a>1. Service 域名（最常用）</h4><p>Service 是集群内服务发现的核心，CoreDNS 会为每个 Service 自动生成域名，格式为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;service-name&gt;.&lt;namespace&gt;.svc.&lt;cluster-domain&gt;</span><br></pre></td></tr></table></figure><ul><li><code>&lt;service-name&gt;</code>：Service 的名称（如 <code>my-service</code>）；</li><li><code>&lt;namespace&gt;</code>：Service 所在的命名空间（如 <code>default</code>）；</li><li><code>&lt;cluster-domain&gt;</code>：集群域名（默认是 <code>cluster.local</code>，可通过 K8s 配置修改）。</li></ul><p><strong>解析结果</strong>：Service 的 ClusterIP（如 <code>10.96.1.23</code>）。</p><p><strong>使用场景</strong>：</p><ul><li>同一命名空间内的 Pod 访问 Service，可简化为 <code>&lt;service-name&gt;</code>（如 <code>my-service</code>），CoreDNS 会自动补全命名空间和集群域名；</li><li>跨命名空间访问 Service，需指定完整域名（如 <code>my-service.prod.svc.cluster.local</code>，访问 <code>prod</code> 命名空间的 <code>my-service</code>）。</li></ul><p><strong>实战示例</strong>：假设 <code>default</code> 命名空间有一个 Service 名为 <code>payment-service</code>（端口 <code>80</code>），Pod 中访问该服务的方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同一命名空间（default），简化域名</span></span><br><span class="line">curl http://payment-service:80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跨命名空间（如从 dev 命名空间访问 default 命名空间的服务）</span></span><br><span class="line">curl http://payment-service.default.svc.cluster.local:80</span><br></pre></td></tr></table></figure><h4 id="2-Pod-域名（可选）"><a href="#2-Pod-域名（可选）" class="headerlink" title="2. Pod 域名（可选）"></a>2. Pod 域名（可选）</h4><p>默认情况下，Pod 的域名由 K8s 自动生成，格式为 <code>&lt;pod-ip&gt;-&lt;namespace&gt;.pod.&lt;cluster-domain&gt;</code>（如 <code>10-244-0-10-default.pod.cluster.local</code>），但这种格式不便于使用。</p><p>若需为 Pod 配置自定义域名，可通过 <code>hostname</code> 和 <code>subdomain</code> 字段配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod-with-dns.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">web</span>  <span class="comment"># Pod 的主机名（必填）</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">app</span> <span class="comment"># 子域名（需配合 Headless Service 使用）</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：Pod 自定义域名需要配合 <strong>Headless Service</strong>（无 ClusterIP 的 Service）使用，Headless Service 的名称需与 Pod 的 <code>subdomain</code> 一致：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># headless-service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app</span>  <span class="comment"># 与 Pod 的 subdomain 一致</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span>  <span class="comment"># 关联 Pod 的标签</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span>  <span class="comment"># 声明为 Headless Service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p><strong>最终 Pod 域名</strong>：<code>web.app.default.svc.cluster.local</code>，其他 Pod 可通过该域名访问此 Pod。</p><h4 id="3-外部域名（转发解析）"><a href="#3-外部域名（转发解析）" class="headerlink" title="3. 外部域名（转发解析）"></a>3. 外部域名（转发解析）</h4><p>CoreDNS 默认会转发集群内无法解析的域名（如 <code>www.baidu.com</code>、<code>github.com</code>）到节点的 DNS 服务器（配置在 <code>/etc/resolv.conf</code>），确保 Pod 能访问外部网络。</p><p>若需自定义外部域名转发规则（如转发公司内部域名到专用 DNS 服务器），可修改 CoreDNS 的 ConfigMap：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit configmap coredns -n kube-system</span><br></pre></td></tr></table></figure><p>添加自定义转发规则（示例：转发 <code>company.com</code> 域名到 <code>192.168.1.100</code> DNS 服务器）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors</span></span><br><span class="line"><span class="string">        health &#123;</span></span><br><span class="line"><span class="string">            lameduck 5s</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ready</span></span><br><span class="line"><span class="string">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span></span><br><span class="line"><span class="string">            pods insecure</span></span><br><span class="line"><span class="string">            fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">            ttl 30</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        # 自定义转发规则：company.com 域名转发到 192.168.1.100</span></span><br><span class="line"><span class="string">        forward . company.com 192.168.1.100</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        loop</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure><h3 id="三、DNS-配置与优化：解决解析问题"><a href="#三、DNS-配置与优化：解决解析问题" class="headerlink" title="三、DNS 配置与优化：解决解析问题"></a>三、DNS 配置与优化：解决解析问题</h3><h4 id="1-Pod-的-DNS-配置文件"><a href="#1-Pod-的-DNS-配置文件" class="headerlink" title="1. Pod 的 DNS 配置文件"></a>1. Pod 的 DNS 配置文件</h4><p>每个 Pod 的 <code>/etc/resolv.conf</code> 文件由 K8s 自动生成，包含 CoreDNS 的 ClusterIP、搜索域（search domains）等配置，示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 10.96.0.10  # CoreDNS 的 ClusterIP</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local  # 搜索域</span><br><span class="line">options ndots:5  # 解析域名时，若域名包含的点少于 5 个，会自动拼接搜索域</span><br></pre></td></tr></table></figure><p><strong>关键参数说明</strong>：</p><ul><li><code>search</code>：搜索域列表，当访问短域名（如 <code>payment-service</code>）时，CoreDNS 会按顺序拼接搜索域，尝试解析 <code>payment-service.default.svc.cluster.local</code>、<code>payment-service.svc.cluster.local</code> 等；</li><li><code>ndots:5</code>：控制短域名拼接规则，默认值为 5，意味着若域名包含的点少于 5 个（如 <code>payment-service</code> 含 0 个点），会优先使用搜索域拼接；若域名包含 5 个及以上点（如 <code>a.b.c.d.e.f</code>），则直接解析。</li></ul><h4 id="2-常见-DNS-问题与解决方案"><a href="#2-常见-DNS-问题与解决方案" class="headerlink" title="2. 常见 DNS 问题与解决方案"></a>2. 常见 DNS 问题与解决方案</h4><h5 id="问题-1：Pod-无法解析-Service-名称"><a href="#问题-1：Pod-无法解析-Service-名称" class="headerlink" title="问题 1：Pod 无法解析 Service 名称"></a>问题 1：Pod 无法解析 Service 名称</h5><ul><li>排查步骤：<ol><li>检查 CoreDNS Pod 是否正常运行（<code>kubectl get pods -n kube-system -l k8s-app=kube-dns</code>）；</li><li>进入 Pod 内部，测试 DNS 解析（<code>nslookup my-service.default.svc.cluster.local 10.96.0.10</code>）；</li><li>检查 Pod 的 <code>/etc/resolv.conf</code> 是否正确配置（是否包含 <code>nameserver 10.96.0.10</code>）。</li></ol></li><li>解决方案：<ul><li>若 CoreDNS 未运行，重启 CoreDNS Pod（<code>kubectl delete pods -n kube-system -l k8s-app=kube-dns</code>）；</li><li>若解析超时，检查网络插件是否正常（如 Flannel&#x2F;Calico 是否运行），确保 Pod 能访问 CoreDNS 的 <code>53</code> 端口（TCP&#x2F;UDP）。</li></ul></li></ul><h5 id="问题-2：短域名解析缓慢或失败"><a href="#问题-2：短域名解析缓慢或失败" class="headerlink" title="问题 2：短域名解析缓慢或失败"></a>问题 2：短域名解析缓慢或失败</h5><ul><li><p><strong>原因</strong>：<code>ndots:5</code> 配置导致短域名会多次拼接搜索域解析，增加延迟；</p></li><li><p>解决方案：</p><ol><li><p>访问跨命名空间 Service 时，使用完整域名（如 <code>my-service.prod.svc.cluster.local</code>）；</p></li><li><p>自定义 Pod 的 DNS 配置，调整<code>ndots</code>值（需在 Pod .spec 中配置）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">dnsConfig:</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ndots</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;2&quot;</span>  <span class="comment"># 减少拼接搜索域的次数</span></span><br></pre></td></tr></table></figure></li></ol></li></ul><h5 id="问题-3：Pod-无法解析外部域名"><a href="#问题-3：Pod-无法解析外部域名" class="headerlink" title="问题 3：Pod 无法解析外部域名"></a>问题 3：Pod 无法解析外部域名</h5><ul><li>排查步骤：<ol><li>进入 Pod 内部，测试解析外部域名（<code>nslookup www.baidu.com</code>）；</li><li>检查节点的 <code>/etc/resolv.conf</code> 是否配置了有效的 DNS 服务器；</li><li>检查 CoreDNS 是否正常转发外部域名（查看 CoreDNS 日志：<code>kubectl logs -n kube-system -l k8s-app=kube-dns</code>）。</li></ol></li><li>解决方案：<ul><li>若节点 DNS 配置无效，修改节点的 <code>/etc/resolv.conf</code>，添加公共 DNS（如 <code>8.8.8.8</code>、<code>114.114.114.114</code>）；</li><li>若 CoreDNS 转发失败，检查集群网络是否允许 CoreDNS 访问外部 DNS 服务器的 <code>53</code> 端口。</li></ul></li></ul><h4 id="3-DNS-性能优化"><a href="#3-DNS-性能优化" class="headerlink" title="3. DNS 性能优化"></a>3. DNS 性能优化</h4><ul><li>启用 CoreDNS 缓存：默认已启用，缓存时长 30 秒（可通过 ConfigMap 调整 <code>cache</code> 字段）；</li><li>减少搜索域数量：若无需跨命名空间访问，可在 Pod 的 <code>dnsConfig</code> 中自定义 <code>search</code> 域，减少拼接次数；</li><li>部署多个 CoreDNS 副本：提高可用性和并发处理能力（默认 2 个副本，可通过 <code>kubectl scale deployment coredns -n kube-system --replicas=3</code> 调整）。</li></ul><h3 id="四、DNS-实战：从配置到验证"><a href="#四、DNS-实战：从配置到验证" class="headerlink" title="四、DNS 实战：从配置到验证"></a>四、DNS 实战：从配置到验证</h3><h4 id="1-部署测试-Service-和-Pod"><a href="#1-部署测试-Service-和-Pod" class="headerlink" title="1. 部署测试 Service 和 Pod"></a>1. 部署测试 Service 和 Pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署一个 Nginx Service 和 Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><h4 id="2-验证-DNS-解析"><a href="#2-验证-DNS-解析" class="headerlink" title="2. 验证 DNS 解析"></a>2. 验证 DNS 解析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入另一个测试 Pod（如 busybox）</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> busybox --image=busybox:1.35 -- sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 解析同一命名空间的 Service（简化域名）</span></span><br><span class="line">nslookup nginx-service</span><br><span class="line"><span class="comment"># 预期输出：Address 1: 10.96.x.x nginx-service.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 解析完整域名</span></span><br><span class="line">nslookup nginx-service.default.svc.cluster.local</span><br><span class="line"><span class="comment"># 预期输出：Address 1: 10.96.x.x nginx-service.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 解析外部域名</span></span><br><span class="line">nslookup www.baidu.com</span><br><span class="line"><span class="comment"># 预期输出：Address 1: 180.101.49.11（百度 IP）</span></span><br></pre></td></tr></table></figure><h4 id="3-自定义-Pod-DNS-配置"><a href="#3-自定义-Pod-DNS-配置" class="headerlink" title="3. 自定义 Pod DNS 配置"></a>3. 自定义 Pod DNS 配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义 DNS 搜索域和 ndots 值</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-dns-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span><br><span class="line">  <span class="attr">dnsConfig:</span></span><br><span class="line">    <span class="attr">searches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prod.svc.cluster.local</span>  <span class="comment"># 优先搜索 prod 命名空间</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">default.svc.cluster.local</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ndots</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">timeout</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;2&quot;</span>  <span class="comment"># 解析超时时间 2 秒</span></span><br></pre></td></tr></table></figure><h2 id="常见问题与排查技巧"><a href="#常见问题与排查技巧" class="headerlink" title="常见问题与排查技巧"></a>常见问题与排查技巧</h2><h3 id="网络异常场景"><a href="#网络异常场景" class="headerlink" title="网络异常场景"></a>网络异常场景</h3><h4 id="1-同一节点-Pod-无法互通"><a href="#1-同一节点-Pod-无法互通" class="headerlink" title="1. 同一节点 Pod 无法互通"></a>1. 同一节点 Pod 无法互通</h4><ul><li><strong>现象</strong>：同一节点上的两个 Pod 互相 <code>ping</code> 不通，或无法访问对方端口；</li><li><strong>可能原因</strong>：节点网桥（<code>cni0</code>）配置异常、容器网络接口未正确创建、防火墙规则拦截。</li></ul><h4 id="2-跨节点-Pod-无法互通"><a href="#2-跨节点-Pod-无法互通" class="headerlink" title="2. 跨节点 Pod 无法互通"></a>2. 跨节点 Pod 无法互通</h4><ul><li><strong>现象</strong>：同一集群不同节点的 Pod 无法通信，<code>ping</code> 目标 Pod IP 超时；</li><li><strong>可能原因</strong>：网络插件（如 Flannel）未正常运行、节点子网分配冲突、跨节点网络链路不通（如防火墙拦截 VXLAN 端口 <code>8472</code>）。</li></ul><h4 id="3-外部无法访问集群服务"><a href="#3-外部无法访问集群服务" class="headerlink" title="3. 外部无法访问集群服务"></a>3. 外部无法访问集群服务</h4><ul><li><strong>现象</strong>：通过 NodePort&#x2F;LoadBalancer&#x2F;Ingress 访问服务超时或报错；</li><li><strong>可能原因</strong>：Service 未关联 Pod（标签选择器不匹配）、Ingress Controller 未安装、节点安全组 &#x2F; 防火墙拦截端口。</li></ul><h4 id="4-DNS-解析失败"><a href="#4-DNS-解析失败" class="headerlink" title="4. DNS 解析失败"></a>4. DNS 解析失败</h4><ul><li><strong>现象</strong>：Pod 无法通过 Service 名称访问服务，<code>nslookup</code> 命令报错（如 <code>server can&#39;t find xxx: NXDOMAIN</code>）；</li><li><strong>可能原因</strong>：CoreDNS 未正常运行、Pod 的 <code>/etc/resolv.conf</code> 配置异常、Service 名称或命名空间错误。</li></ul><h3 id="排查方法与工具"><a href="#排查方法与工具" class="headerlink" title="排查方法与工具"></a>排查方法与工具</h3><h4 id="1-基础排查工具"><a href="#1-基础排查工具" class="headerlink" title="1. 基础排查工具"></a>1. 基础排查工具</h4><ul><li><strong>kubectl</strong>：查看资源状态、日志；</li><li><strong>ping</strong>：测试 Pod IP 连通性；</li><li><strong>telnet&#x2F;nc</strong>：测试端口可达性（如 <code>telnet 10.244.1.10 8080</code>）；</li><li><strong>nslookup&#x2F;dig</strong>：测试 DNS 解析（如 <code>nslookup my-service</code>）；</li><li><strong>tcpdump</strong>：抓包分析流量（如 <code>tcpdump -i eth0 host 10.244.1.10</code>）；</li><li><strong>iproute2</strong>：查看网络配置（如 <code>ip addr</code>、<code>ip route</code>）。</li></ul><h4 id="2-分步排查流程"><a href="#2-分步排查流程" class="headerlink" title="2. 分步排查流程"></a>2. 分步排查流程</h4><h5 id="步骤-1：检查-Pod-状态"><a href="#步骤-1：检查-Pod-状态" class="headerlink" title="步骤 1：检查 Pod 状态"></a>步骤 1：检查 Pod 状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o wide</span><br><span class="line"><span class="comment"># 确保 Pod 处于 Running 状态，且节点分配正常</span></span><br></pre></td></tr></table></figure><h5 id="步骤-2：检查网络插件状态"><a href="#步骤-2：检查网络插件状态" class="headerlink" title="步骤 2：检查网络插件状态"></a>步骤 2：检查网络插件状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 Flannel 状态</span></span><br><span class="line">kubectl get pods -n kube-system -l app=flannel</span><br><span class="line"><span class="comment"># 检查 Calico 状态</span></span><br><span class="line">kubectl get pods -n calico-system</span><br></pre></td></tr></table></figure><h5 id="步骤-3：测试-Pod-内部网络"><a href="#步骤-3：测试-Pod-内部网络" class="headerlink" title="步骤 3：测试 Pod 内部网络"></a>步骤 3：测试 Pod 内部网络</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入 Pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- sh</span><br><span class="line"><span class="comment"># 查看网络接口</span></span><br><span class="line">ip addr</span><br><span class="line"><span class="comment"># 查看路由表</span></span><br><span class="line">ip route</span><br><span class="line"><span class="comment"># 测试 localhost 通信（同一 Pod 内容器）</span></span><br><span class="line">curl localhost:&lt;port&gt;</span><br></pre></td></tr></table></figure><h5 id="步骤-4：测试-Pod-之间通信"><a href="#步骤-4：测试-Pod-之间通信" class="headerlink" title="步骤 4：测试 Pod 之间通信"></a>步骤 4：测试 Pod 之间通信</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同一节点 Pod 通信</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod1-name&gt; -- ping &lt;pod2-ip&gt;</span><br><span class="line"><span class="comment"># 跨节点 Pod 通信</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod1-name&gt; -- ping &lt;跨节点-pod-ip&gt;</span><br><span class="line"><span class="comment"># 测试端口可达性</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod1-name&gt; -- nc -zv &lt;pod2-ip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><h5 id="步骤-5：测试-Service-访问"><a href="#步骤-5：测试-Service-访问" class="headerlink" title="步骤 5：测试 Service 访问"></a>步骤 5：测试 Service 访问</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Service 状态和 ClusterIP</span></span><br><span class="line">kubectl get svc</span><br><span class="line"><span class="comment"># 测试访问 Service ClusterIP</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- curl &lt;service-clusterip&gt;:&lt;port&gt;</span><br><span class="line"><span class="comment"># 测试 DNS 解析 Service 名称</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- nslookup &lt;service-name&gt;</span><br></pre></td></tr></table></figure><h5 id="步骤-6：测试外部访问"><a href="#步骤-6：测试外部访问" class="headerlink" title="步骤 6：测试外部访问"></a>步骤 6：测试外部访问</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NodePort 模式：测试节点 IP:NodePort</span></span><br><span class="line">curl &lt;node-ip&gt;:&lt;node-port&gt;</span><br><span class="line"><span class="comment"># Ingress 模式：测试域名访问（需配置本地 hosts 或 DNS）</span></span><br><span class="line">curl http://app.example.com</span><br></pre></td></tr></table></figure><h5 id="步骤-7：抓包分析（进阶）"><a href="#步骤-7：抓包分析（进阶）" class="headerlink" title="步骤 7：抓包分析（进阶）"></a>步骤 7：抓包分析（进阶）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 Pod 内抓包</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- tcpdump -i eth0 host &lt;target-ip&gt; -w /tmp/traffic.pcap</span><br><span class="line"><span class="comment"># 复制抓包文件到本地分析（需安装 tcpdump）</span></span><br><span class="line">kubectl <span class="built_in">cp</span> &lt;pod-name&gt;:/tmp/traffic.pcap ./traffic.pcap</span><br></pre></td></tr></table></figure><h2 id="案例分析：故障解决与优化"><a href="#案例分析：故障解决与优化" class="headerlink" title="案例分析：故障解决与优化"></a>案例分析：故障解决与优化</h2><h3 id="案例背景"><a href="#案例背景" class="headerlink" title="案例背景"></a>案例背景</h3><p>某电商平台的 K8s 集群（3 个节点，使用 Flannel VXLAN 模式），线上环境出现 “订单服务无法访问支付服务” 的故障，现象如下：</p><ol><li>订单服务 Pod（<code>10.244.0.20</code>，节点 A）无法通过支付服务的 Service 名称 <code>payment-service</code> 访问，报错 <code>curl: (6) Could not resolve host: payment-service</code>；</li><li>直接通过支付服务 Pod IP（<code>10.244.1.30</code>，节点 B）访问正常；</li><li>其他服务（如商品服务）可正常通过 Service 名称访问支付服务。</li></ol><h3 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h3><h4 id="步骤-1：检查-Service-和-Pod-关联状态"><a href="#步骤-1：检查-Service-和-Pod-关联状态" class="headerlink" title="步骤 1：检查 Service 和 Pod 关联状态"></a>步骤 1：检查 Service 和 Pod 关联状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看支付服务 Service</span></span><br><span class="line">kubectl get svc payment-service -o wide</span><br><span class="line"><span class="comment"># 输出：NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span></span><br><span class="line"><span class="comment">#       payment-service   ClusterIP   10.96.5.78   &lt;none&gt;        80/TCP    10d   app=payment</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看支付服务 Pod</span></span><br><span class="line">kubectl get pods -l app=payment -o wide</span><br><span class="line"><span class="comment"># 输出：NAME                            READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE</span></span><br><span class="line"><span class="comment">#       payment-pod-7f98d7c6b4-2xqzk   1/1     Running   0          5d    10.244.1.30   node-b   &lt;none&gt;</span></span><br></pre></td></tr></table></figure><p>结论：Service 标签选择器 <code>app=payment</code> 与 Pod 标签匹配，ClusterIP 为 <code>10.96.5.78</code>，状态正常。</p><h4 id="步骤-2：测试订单服务-Pod-的-DNS-解析"><a href="#步骤-2：测试订单服务-Pod-的-DNS-解析" class="headerlink" title="步骤 2：测试订单服务 Pod 的 DNS 解析"></a>步骤 2：测试订单服务 Pod 的 DNS 解析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入订单服务 Pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it order-pod-67f89d7c5d-9x7zk -- sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试解析 payment-service</span></span><br><span class="line">nslookup payment-service</span><br><span class="line"><span class="comment"># 输出：server can&#x27;t find payment-service: NXDOMAIN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试解析完整域名</span></span><br><span class="line">nslookup payment-service.default.svc.cluster.local</span><br><span class="line"><span class="comment"># 输出：server can&#x27;t find payment-service.default.svc.cluster.local: NXDOMAIN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试解析其他 Service（如 product-service）</span></span><br><span class="line">nslookup product-service</span><br><span class="line"><span class="comment"># 输出：Address 1: 10.96.8.123 product-service.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 的 /etc/resolv.conf</span></span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># nameserver 10.96.0.10</span></span><br><span class="line"><span class="comment"># search prod.svc.cluster.local svc.cluster.local cluster.local</span></span><br><span class="line"><span class="comment"># options ndots:5</span></span><br></pre></td></tr></table></figure><p>关键发现：订单服务 Pod 的 <code>search</code> 域包含 <code>prod.svc.cluster.local</code>，而支付服务位于 <code>default</code> 命名空间，订单服务 Pod 拼接搜索域时优先使用 <code>prod</code> 命名空间，导致解析失败。</p><h4 id="步骤-3：验证命名空间配置"><a href="#步骤-3：验证命名空间配置" class="headerlink" title="步骤 3：验证命名空间配置"></a>步骤 3：验证命名空间配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看订单服务 Pod 所在命名空间</span></span><br><span class="line">kubectl get pods order-pod-67f89d7c5d-9x7zk -o jsonpath=<span class="string">&#x27;&#123;.metadata.namespace&#125;&#x27;</span></span><br><span class="line"><span class="comment"># 输出：prod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看支付服务所在命名空间</span></span><br><span class="line">kubectl get svc payment-service -o jsonpath=<span class="string">&#x27;&#123;.metadata.namespace&#125;&#x27;</span></span><br><span class="line"><span class="comment"># 输出：default</span></span><br></pre></td></tr></table></figure><p>结论：订单服务位于 <code>prod</code> 命名空间，支付服务位于 <code>default</code> 命名空间，订单服务 Pod 访问跨命名空间 Service 时未使用完整域名，导致 DNS 解析失败。</p><h3 id="解决方案与优化措施"><a href="#解决方案与优化措施" class="headerlink" title="解决方案与优化措施"></a>解决方案与优化措施</h3><h4 id="1-临时解决方案：使用完整域名访问"><a href="#1-临时解决方案：使用完整域名访问" class="headerlink" title="1. 临时解决方案：使用完整域名访问"></a>1. 临时解决方案：使用完整域名访问</h4><p>修改订单服务的配置，将访问地址从 <code>payment-service:80</code> 改为 <code>payment-service.default.svc.cluster.local:80</code>，部署后测试正常。</p><h4 id="2-长期优化方案：调整-Pod-DNS-配置"><a href="#2-长期优化方案：调整-Pod-DNS-配置" class="headerlink" title="2. 长期优化方案：调整 Pod DNS 配置"></a>2. 长期优化方案：调整 Pod DNS 配置</h4><p>为 <code>prod</code> 命名空间的 Pod 添加 <code>default</code> 命名空间到搜索域，避免跨命名空间访问时解析失败：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 prod 命名空间创建 Pod 时，添加 DNS 配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">order-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">order-service:v1.0</span></span><br><span class="line">  <span class="attr">dnsConfig:</span></span><br><span class="line">    <span class="attr">searches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prod.svc.cluster.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">default.svc.cluster.local</span>  <span class="comment"># 添加 default 命名空间搜索域</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">svc.cluster.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cluster.local</span></span><br></pre></td></tr></table></figure><h4 id="3-集群层面优化：统一命名空间规划"><a href="#3-集群层面优化：统一命名空间规划" class="headerlink" title="3. 集群层面优化：统一命名空间规划"></a>3. 集群层面优化：统一命名空间规划</h4><ul><li>规范服务命名空间：将关联紧密的服务部署在同一命名空间（如 <code>payment</code> 命名空间部署支付相关服务，<code>order</code> 命名空间部署订单相关服务）；</li><li>为跨命名空间的核心服务创建别名 Service：在常用命名空间中创建指向核心服务的别名 Service，避免记忆完整域名。</li></ul><h4 id="4-监控优化：添加-DNS-解析监控"><a href="#4-监控优化：添加-DNS-解析监控" class="headerlink" title="4. 监控优化：添加 DNS 解析监控"></a>4. 监控优化：添加 DNS 解析监控</h4><ul><li>部署 Prometheus + Grafana 监控 CoreDNS 指标（如 <code>coredns_dns_requests_total</code>、<code>coredns_dns_request_duration_seconds_sum</code>）；</li><li>配置告警规则：当 DNS 解析失败率超过阈值（如 1%）时，及时告警。</li></ul><h2 id="总结与展望"><a href="#总结与展望" class="headerlink" title="总结与展望"></a>总结与展望</h2><p>K8s Pod 网络是云原生应用通信的基础，其核心围绕 “Pod IP 全局可达” 和 “服务发现” 展开。本文从 Pod 网络类型、工作原理、主流插件、DNS 配置、网络安全、故障排查等维度，系统讲解了 Pod 网络的核心知识，并通过实战案例验证了理论的实用性。</p><p>核心要点回顾：</p><ol><li>同一 Pod 内容器共享网络命名空间，通过 <code>localhost</code> 通信；</li><li>不同 Pod 依赖 CNI 插件实现互通，Flannel 适合轻量场景，Calico 适合生产环境；</li><li>Service 提供固定访问入口，Ingress 是外部访问的首选方案；</li><li>CoreDNS 实现域名解析，支持 Service、Pod 域名，需注意跨命名空间解析规则；</li><li>NetworkPolicy 提供细粒度网络安全控制，生产环境建议启用。</li></ol><p>未来展望：</p><ul><li>随着 eBPF 技术的兴起，Cilium 等基于 eBPF 的网络插件将成为主流，提供更高性能和更丰富的功能；</li><li>服务网格（如 Istio）将与 Pod 网络深度融合，实现更细粒度的流量控制、可观测性和安全加密；</li><li>K8s 网络将向 “零信任” 架构演进，网络策略、加密通信、身份认证将成为默认配置。</li></ul><p>对于开发者和运维人员而言，掌握 Pod 网络的核心原理和排查技巧，是保障 K8s 集群稳定运行的关键。建议在实际环境中多动手实践，结合监控工具及时发现并解决网络问题，为云原生应用提供可靠的通信基础。</p></div></article></div><footer class="bg-gradient-to-r from-purple-700 to-blue-600 text-white py-8 mt-auto"><div class="container mx-auto px-4"><div class="flex flex-col md:flex-row md:justify-between md:items-start space-y-6 md:space-y-0"><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">志强vlog</h3><p class="text-sm opacity-80">感谢您的访问！这里是 王志强 专属博客，分享生活与技术。</p></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">快捷导航</h3><ul class="space-y-2 text-sm opacity-90"><li><a href="/" class="hover:text-yellow-300 transition">Home</a></li><li><a href="/archives" class="hover:text-yellow-300 transition">Archives</a></li><li><a href="/resources" class="hover:text-yellow-300 transition">Rsources</a></li><li><a href="/tags" class="hover:text-yellow-300 transition">Tags</a></li><li><a href="/about" class="hover:text-yellow-300 transition">About</a></li><li><a href="/sitemap.xml" class="hover:text-yellow-300 transition">RSS</a></li></ul></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">友情链接</h3><ul class="space-y-2 text-sm opacity-90"><li><a href="https://cnb.cool/zhiqiangwang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">CNB</a></li><li><a href="https://github.com/chihqiang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">GitHub</a></li><li><a href="https://www.zhiqiang.wang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">志强vlog</a></li></ul></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">联系方式</h3><p class="text-sm opacity-80 flex items-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-18 8h18a2 2 0 002-2V8a2 2 0 00-2-2H3a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg> <a href="mailto:zhiqiang2033@gmail.com" class="hover:text-yellow-300">zhiqiang2033@gmail.com</a></p><p class="text-sm opacity-80 flex items-center space-x-2 mt-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 21s8-4.5 8-10a8 8 0 10-16 0c0 5.5 8 10 8 10z"/></svg> <span>中国</span></p></div></div><hr class="my-6 border-purple-400 opacity-50"><p class="text-center text-sm opacity-70 mb-2">© 2024 志强vlog. 保留所有权利.</p><p class="text-center text-xs opacity-50">由 <a href="https://hexo.io/" target="_blank" rel="noopener" class="underline hover:text-yellow-300">Hexo</a> 驱动，主题由 <a href="https://github.com/chihqiang/hexo-theme-tailog" target="_blank" rel="noopener" class="underline hover:text-yellow-300">hexo-theme-tailog</a> 提供。</p></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-TBH6G20B8Y"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TBH6G20B8Y")</script></footer><button id="back-to-top" class="fixed bottom-8 right-8 bg-gradient-to-r from-purple-500 to-blue-500 text-white p-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 opacity-0 invisible z-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg></button></body></html>