<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>从 GitHub Actions 迁移到 CNB | 志强vlog</title><meta name="keywords" content="github,cnb"><meta name="description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta property="og:type" content="article"><meta property="og:title" content="从 GitHub Actions 迁移到 CNB | 志强vlog"><meta property="og:description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta property="og:url" content="https://www.zhiqiang.wang/2025/08/21/git/action-github-cnb/"><meta property="og:image" content="/img/favicon.ico"><meta property="og:site_name" content="志强vlog"><meta property="article:published_time" content="Thu Aug 21 2025 13:37:58 GMT+0800"><meta property="article:author" content="王志强"><meta property="article:tag" content="github"><meta property="article:tag" content="cnb"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="从 GitHub Actions 迁移到 CNB | 志强vlog"><meta name="twitter:description" content="志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"><meta name="twitter:image" content="/img/favicon.ico"><script type="application/ld+json">{
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "从 GitHub Actions 迁移到 CNB",
      "image": "/img/favicon.ico",
      "author": {
        "@type": "Person",
        "name": "王志强"
      },
      "datePublished": "Thu Aug 21 2025 13:37:58 GMT+0800",
      "dateModified": "Thu Jan 08 2026 06:03:16 GMT+0000",
      "description": "志强的个人博客，分享 Node.js、PHP、Go、Java 和 Python 后端开发经验，以及生活中的点滴感悟与故事。
"
    }</script><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"><script>"dark"===localStorage.getItem("theme")||!localStorage.getItem("theme")&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><script src="https://cdn.tailwindcss.com/3.4.16"></script><script>tailwind.config={darkMode:"class",theme:{extend:{}}}</script><script src="https://unpkg.com/alpinejs@3.14.9/dist/cdn.min.js" defer></script><link rel="stylesheet" href="/css/blog.css"><script src="/js/blog.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body class="bg-gradient-to-br from-purple-100 to-blue-100 dark:from-gray-900 dark:to-gray-800 min-h-screen flex flex-col transition-colors duration-300"><nav id="navbar" class="bg-gradient-to-r from-purple-600 to-blue-500 shadow-lg dark:from-gray-800 dark:to-gray-700 transition-all duration-300 sticky top-0 z-40"><div class="container mx-auto px-4 py-3"><div class="flex justify-between items-center"><h1 class="text-white text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-pink-400"><a href="/">志强vlog</a></h1><div id="desktop-menu" class="hidden lg:flex items-center space-x-1"><a href="/" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="0">Home </a><a href="/archives" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="1">Archives </a><a href="/resources" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="2">Rsources </a><a href="/tags" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="3">Tags </a><a href="/about" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="4">About </a><a href="/sitemap.xml" class="nav-item text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10" data-index="5">RSS</a><div id="dropdown-menu" class="relative group hidden"><button class="text-white hover:text-yellow-200 transition duration-300 font-medium px-3 py-2 rounded-lg hover:bg-white/10 flex items-center">更多 <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="dropdown-content" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0"></div></div></div><div class="flex items-center space-x-1 sm:space-x-2"><button id="searchButton" class="p-2 sm:p-2.5 rounded-full bg-white/20 hover:bg-white/30 transition-all duration-300 text-white hover:scale-110 active:scale-95" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button> <button id="theme-toggle" class="p-2 sm:p-2.5 rounded-full bg-white/20 hover:bg-white/30 transition-all duration-300 text-white hover:scale-110 active:scale-95" aria-label="切换主题"><svg id="sun-icon" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg> <svg id="moon-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg></button> <button id="mobile-menu-button" aria-label="切换菜单" class="lg:hidden p-2 sm:p-2.5 rounded-lg hover:bg-white/10 transition-all duration-300 text-white hover:scale-110 active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div></div></div><div id="mobile-menu" class="lg:hidden hidden bg-gradient-to-r from-purple-600 to-blue-500 dark:from-gray-800 dark:to-gray-700 px-4 pb-4 transition-all duration-300"><div class="space-y-1"><a href="/" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Home</span> </a><a href="/archives" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Archives</span> </a><a href="/resources" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Rsources</span> </a><a href="/tags" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">Tags</span> </a><a href="/about" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">About</span> </a><a href="/sitemap.xml" class="block text-white py-3 px-4 rounded-lg hover:bg-white/10 transition-all duration-200 flex items-center group"><svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> <span class="font-medium group-hover:translate-x-1 transition-all duration-200">RSS</span></a></div></div></nav><div id="searchOverlay" class="overlay hidden"></div><div id="inputContainer" class="floating-search hidden"><input type="text" id="inputField" placeholder="搜索文章..." class="search-input" autocomplete="off"><div id="articleList" class="search-results"></div></div><script>document.addEventListener("DOMContentLoaded",DOMContentLoadedSearch)</script><div id="reading-progress" class="fixed top-0 left-0 h-1 bg-gradient-to-r from-purple-500 to-blue-500 z-50 transition-all duration-150" style="width:0%"></div><div class="container mx-auto px-4 py-8"><article class="bg-white p-6 sm:p-8 rounded-xl shadow-lg transition hover:scale-[1.01] max-w-5xl mx-auto mt-8"><header class="mb-6 sm:mb-8"><h1 class="text-3xl sm:text-4xl font-bold mb-3 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">从 GitHub Actions 迁移到 CNB</h1><div class="flex flex-wrap items-center text-gray-500 text-sm space-x-4"><span>2025-08-21</span> <span><a href="/categories/git/" class="text-blue-600 hover:underline">git</a> </span><span><a href="/tags/github/" class="text-blue-600 hover:underline">github</a>, <a href="/tags/cnb/" class="text-blue-600 hover:underline">cnb</a></span></div></header><div class="article-content prose prose-base lg:prose-lg max-w-none"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>GitHub Actions 和 CNB 都允许您创建能自动构建、测试、发布、发行和部署代码的工作流。 CNB 和 GitHub Actions 的工作流配置有一些相似之处：</p><ul><li>工作流配置文件以 YAML 编写并存储在代码仓库中。（在 CNB 中，工作流称为流水线 Pipeline）</li><li>工作流包括一项或多项任务。（在 CNB 中，任务对应的是阶段 Stage）</li><li>任务包括一个或多个步骤或单个命令。(在 CNB 中，步骤对应的是任务 Job , 每个任务可以执行一系列命令或者插件)</li></ul><p>本指南将重点说明两者差异，以便您将 GitHub Actions 迁移到 CNB。</p><h2 id="工作流配置"><a href="#工作流配置" class="headerlink" title="工作流配置"></a>工作流配置</h2><ul><li>GitHub Actions 是每个工作流配置为一个单独的 YAML 文件，存放在<code>.github/workflows</code>目录。</li><li>CNB 是所有工作流配置文件都存储在仓库根目录名为 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/quick-start.html">.cnb.yml</a> 的文件中（也可以通过 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/configuration.html#include">include</a> 关键字在文件中导入其他配置文件）。</li></ul><p>以下是两者语法的主要差异：</p><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Node.js</span> <span class="string">CI/CD</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">tests</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span> <span class="meta">&amp;build</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Node.js</span> <span class="string">CI/CD</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">          <span class="attr">jobs:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">tests</span></span><br><span class="line">              <span class="attr">script:</span> <span class="string">npm</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">pull_request:</span> <span class="meta">*build</span></span><br></pre></td></tr></table></figure><h2 id="构建触发规则"><a href="#构建触发规则" class="headerlink" title="构建触发规则"></a>构建触发规则</h2><p>在 GitHub Actions 中，通过指定 <code>on</code> 字段定义工作流触发的规则。 在 CNB 中，您可以通过编写<code>触发分支</code>、<code>触发事件</code>来定义构建流水线被触发的规则。详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/trigger-rule.html">构建触发规则</a>。</p><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Node.js</span> <span class="string">CI/CD</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;do some job&quot;</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .cnb.yml</span></span><br><span class="line"><span class="attr">main:</span> <span class="comment"># 触发分支</span></span><br><span class="line">  <span class="attr">push:</span> <span class="comment"># 触发事件，对应一个构建，可以包含多条 Pipeline。即可以是数组，也可以是对象。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">stages:</span> <span class="comment"># 流水线1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;do some job&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Runners"><a href="#Runners" class="headerlink" title="Runners"></a>Runners</h2><ul><li>在 GitHub Actions 中, Runner指的是执行任务的一个虚拟机，比如<code>macOS</code>、<code>Windows</code> <code>Linux</code>等。</li><li>在 CNB 中，Runner指的是一个构建节点（默认是一个运行docker容器的节点），目前CNB提供的官方托管的构建节点，仅支持Linux系统的docker容器作为Runner。而CNB的企业版（私有化版本）, 可以自行接入不同的机器(<code>macOS</code>、<code>Windows</code>、<code>Linux</code>)。具体详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/build/build-node.html">构建集群</a>。</li></ul><p>GitHub Actions 使用<code>runs-on</code>字段指定 Runner，而 CNB 使用 <code>runner</code> 字段指定构建节点的架构（<code>amd64</code>或<code>arm64</code>等）和<code>cpu</code>及<code>内存</code>配置。</p><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">linux_job:</span></span><br><span class="line">  <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;Hello, $USER!&quot;</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">runner:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">cnb:arch:amd64</span> <span class="comment"># 指定在 amd64 架构构建集群上执行</span></span><br><span class="line">        <span class="attr">cpus:</span> <span class="number">16</span> <span class="comment"># 指定分配的CPU数为16核（内存数自动分配为 核数*2 GiB ）</span></span><br><span class="line">      <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu:latest</span> <span class="comment"># 指定使用 ubuntu:latest 镜像作为流水线运行环境</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;Hello, $USER!&quot;</span></span><br></pre></td></tr></table></figure><h2 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h2><ul><li>在 GitHub Actions 中，工作流是运行在一个虚拟机环境，因此构建环境中的需要的任何软件要么是预先安装在虚拟机上的，要么必须手动安装。</li><li>在 CNB 中，工作流是运行在一个或多个可以指定 docker 镜像的 docker 容器中。在构建过程中，只需要在配置文件中指定所需镜像或 Dockerfile 文件，即可完成构建环境的安装。具体详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/build-env.html">构建环境</a>。</li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">linux_job:</span></span><br><span class="line">  <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span> <span class="number">21</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/setup-node@v4</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">node-version:</span> <span class="number">21</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span> <span class="string">--if-present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">node:21</span> <span class="comment"># 使用 node:21 作为流水线运行环境</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span> <span class="string">--if-present</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">npm</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><h2 id="仓库代码准备"><a href="#仓库代码准备" class="headerlink" title="仓库代码准备"></a>仓库代码准备</h2><ul><li>在 GitHub Actions 中，工作流使用 <code>actions/checkout</code> 拉取仓库代码</li><li>在 CNB 中，工作流默认就会拉取仓库代码，无需显示声明。详细配置方式见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/grammar.html#git">流水线语法-仓库配置</a>。</li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">linux_job:</span></span><br><span class="line">  <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">ls</span> <span class="string">-al</span> <span class="string">.</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ls</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">ls</span> <span class="string">-al</span> <span class="string">.</span></span><br></pre></td></tr></table></figure><h2 id="条件触发"><a href="#条件触发" class="headerlink" title="条件触发"></a>条件触发</h2><ul><li>在 GitHub Actions 中，工作流使用<code>if</code>字段设置步骤执行条件。</li><li>在 CNB 中，工作流使用<code>if</code>,<code>ifModify</code>,<code>ifNewBranch</code>等字段设置步骤执行条件。详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/grammar.html#stage-if">流水线语法-if</a>。</li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy_prod:</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">contains(</span> <span class="string">github.ref,</span> <span class="string">&#x27;master&#x27;</span><span class="string">)</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;Deploy to production server&quot;</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">echo</span> <span class="string">&quot;$CNB_BRANCH&quot;</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-q</span> <span class="string">&#x27;master&#x27;</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">production</span> <span class="string">server</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;Deploy to production server&quot;</span></span><br></pre></td></tr></table></figure><h2 id="任务依赖"><a href="#任务依赖" class="headerlink" title="任务依赖"></a>任务依赖</h2><ul><li>在 GitHub Actions 中，工作流使用<code>needs</code>字段定义工作流依赖关系。</li><li>在 CNB 中，工作流使用<code>cnb:await</code>,<code>cnb:resolve</code>两个内置任务，来定义工作流依赖关系和传递变量。详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/internal-steps.html#cnb-await-resolve">await-resolve内置任务</a></li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build_a:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;This job will be run first.&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build_b:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;This job will be run first, in parallel with build_a&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">test_ab:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">needs:</span> [<span class="string">build_a</span>, <span class="string">build_b</span>]</span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;This job will run after build_a and build_b have finished&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">deploy_ab:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">needs:</span> [<span class="string">test_ab</span>]</span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;This job will run after test_ab is complete&quot;</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build_a</span></span><br><span class="line">      <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build_a</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;This job will be run first.&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">resolve</span> <span class="string">for</span> <span class="string">test_ab</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">cnb:resolve</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">build_a</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build_b</span></span><br><span class="line">      <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build_b</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;This job will be run first, in parallel with build_a&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">resolve</span> <span class="string">for</span> <span class="string">test_ab</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">cnb:resolve</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">build_b</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test_ab</span></span><br><span class="line">      <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait</span> <span class="string">for</span> <span class="string">build_a</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">cnb:await</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">build_a</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait</span> <span class="string">for</span> <span class="string">build_b</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">cnb:await</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">build_b</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build_a</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;This job will run after build_a and build_b have finished&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">resolve</span> <span class="string">for</span> <span class="string">test_ab</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">cnb:resolve</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">test_ab</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy_ab</span></span><br><span class="line">      <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait</span> <span class="string">for</span> <span class="string">test_ab</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">cnb:await</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">test_ab</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy_ab</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;This job will run after test_ab is complete&quot;</span></span><br></pre></td></tr></table></figure><h2 id="变量和密钥"><a href="#变量和密钥" class="headerlink" title="变量和密钥"></a>变量和密钥</h2><ul><li>在 GitHub Actions 中，工作流使用<code>env</code>字段指定变量，使用<code>secrets</code>变量来引用密钥。</li><li>在 CNB 中，工作流使用<code>env</code>字段指定变量，用<code>imports</code>字段来引用外部仓库或密钥仓库文件作为环境变量。详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/grammar.html#pipeline-imports">引用变量</a> 和 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/repo/secret.html">密钥仓库</a>。</li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy_prod:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">DEPLOYMENT_ENV:</span> <span class="string">production</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;This job will deploy to the $DEPLOYMENT_ENV server&quot;</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#env.yml</span></span><br><span class="line">DEPLOYMENT_ENV: <span class="string">&quot;production&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#.cnb.yml</span></span><br><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">imports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cnb.cool/&lt;your-repo-slug&gt;/-/blob/main/xxx/env.yml</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">the</span> <span class="string">$DEPLOYMENT_ENV</span> <span class="string">server</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">echo</span> <span class="string">&quot;This job will deploy to the $DEPLOYMENT_ENV server&quot;</span></span><br></pre></td></tr></table></figure><h2 id="矩阵策略"><a href="#矩阵策略" class="headerlink" title="矩阵策略"></a>矩阵策略</h2><ul><li>在 GitHUb Actions 中，工作流可以使用矩阵策略，在单个作业定义中使用变量自动创建基于变量组合的多个作业运行。</li><li>在 CNB 中，工作流不支持这种策略。但可以使用YAML的锚点功能，模拟矩阵策略。参考 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/simplify-configuration.html#yaml-gao-ji-yu-fa">YAML高级语法</a></li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">node-version:</span> [<span class="number">15.</span><span class="string">x</span>, <span class="number">16.</span><span class="string">x</span>]</span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node-version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node-version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">node</span> <span class="string">modules</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">a</span> <span class="string">one-line</span> <span class="string">script</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">a</span> <span class="string">multi-line</span> <span class="string">script</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">node:14</span></span><br><span class="line">      <span class="attr">stages:</span> <span class="string">&amp;BVT-tesing-stages</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">node</span> <span class="string">modules</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">a</span> <span class="string">one-line</span> <span class="string">script</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">a</span> <span class="string">multi-line</span> <span class="string">script</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">node:16</span></span><br><span class="line">      <span class="attr">stages:</span> <span class="string">*BVT-tesing-stages</span></span><br></pre></td></tr></table></figure><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><ul><li>在 GitHub Actions 中，工作流使用缓存策略，将构建过程中产生的中间产物暂存到缓存区，方便下次构建时使用。</li><li>在 CNB 中，工作流使用<code>pipeline.runner.volumes</code>声明<code>节点本地缓存</code>或者使用<code>docker:cache</code>内置任务来声明<code>远端docker镜像缓存</code>，来存放构建过程中的依赖缓存或中间产物。详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/pipeline-cache.html">流水线缓存</a></li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy_prod:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cache</span> <span class="string">node</span> <span class="string">modules</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/cache@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">~/.npm</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-node-$&#123;&#123;</span> <span class="string">hashFiles(&#x27;**/package-lock.json&#x27;)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">restore-keys:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            $&#123;&#123; runner.os &#125;&#125;-node-</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">project</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">ci</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用`pipeline.runner.volumes`声明`节点本地缓存`</span></span><br><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">node:14</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/root/.npm</span> <span class="comment"># 声明本地的缓存目录</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">project</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">ci</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用`docker:cache`内置任务来声明`远端docker镜像缓存`</span></span><br><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">node:14</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build</span> <span class="string">cache</span> <span class="string">image</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">docker:cache</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">dockerfile:</span> <span class="string">cache.dockerfile</span></span><br><span class="line">            <span class="comment"># by 支持以下两种形式：数组、字符串</span></span><br><span class="line">            <span class="attr">by:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">package.json</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">package-lock.json</span></span><br><span class="line">            <span class="comment"># versionBy: package-lock.json</span></span><br><span class="line">            <span class="attr">versionBy:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">package-lock.json</span></span><br><span class="line">          <span class="attr">exports:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">DOCKER_CACHE_IMAGE_NAME</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">use</span> <span class="string">cache</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">$DOCKER_CACHE_IMAGE_NAME</span></span><br><span class="line">          <span class="comment"># 将 cache 中的文件拷贝过来使用</span></span><br><span class="line">          <span class="attr">commands:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">cp</span> <span class="string">-r</span> <span class="string">&quot;$NODE_PATH&quot;</span> <span class="string">./node_modules</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">project</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">npm</span> <span class="string">ci</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure><p>其中 cache.dockerfile 是一个用于构建缓存镜像的 Dockerfile，示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择一个 Base 镜像</span></span><br><span class="line">FROM node:14</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line">WORKDIR /space</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 by 中的文件列表 COPY 过来</span></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据 COPY 过来的文件进行依赖的安装</span></span><br><span class="line">RUN npm ci</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置好需要的环境变量</span></span><br><span class="line">ENV NODE_PATH=/space/node_modules</span><br></pre></td></tr></table></figure><h2 id="制品"><a href="#制品" class="headerlink" title="制品"></a>制品</h2><ul><li>在 Github Actions 中，工作流使用<code>actions/upload-artifact</code>动作上传制品</li><li>在 CNB 中，工作流使用<code>cnbcool/attachments:latest</code>插件上传制品，详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/plugin/#public/cnbcool/attachments">附件插件</a></li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy_prod:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">a</span> <span class="string">Build</span> <span class="string">Artifact</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">my-artifact</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/path/to/artifact</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">a</span> <span class="string">Build</span> <span class="string">Artifact</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">cnbcool/attachments:latest</span></span><br><span class="line">          <span class="attr">settings:</span></span><br><span class="line">            <span class="attr">attachments:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/path/to/artifact</span></span><br></pre></td></tr></table></figure><h2 id="数据库及服务容器"><a href="#数据库及服务容器" class="headerlink" title="数据库及服务容器"></a>数据库及服务容器</h2><ul><li>在 GitHub Actions 中，工作流使用<code>services</code>字段，来编排数据库及服务容器。</li><li>在 CNB 中，工作流可以通过声明<code>docker</code>服务, 直接使用在任务里执行<code>docker</code>或<code>docker compose</code>命令，来启动数据库及服务容器。详见 <a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/grammar.html#service-docker">docker服务</a></li></ul><p>GitHub Actions 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">container-job:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">container:</span> <span class="string">node:20-bookworm-slim</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">      <span class="attr">postgres:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">postgres</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">out</span> <span class="string">repository</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Performs a clean installation of all dependencies</span></span><br><span class="line">      <span class="comment"># in the `package.json` file</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Connect</span> <span class="string">to</span> <span class="string">PostgreSQL</span></span><br><span class="line">        <span class="comment"># Runs a script that creates a PostgreSQL client,</span></span><br><span class="line">        <span class="comment"># populates the client with data, and retrieves data</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">node</span> <span class="string">client.js</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># The hostname used to communicate with the</span></span><br><span class="line">          <span class="comment"># PostgreSQL service container</span></span><br><span class="line">          <span class="attr">POSTGRES_HOST:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="comment"># The default PostgreSQL port</span></span><br><span class="line">          <span class="attr">POSTGRES_PORT:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure><p>CNB 格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接在任务中使用`docker compose`命令，来编排数据库及服务容器</span></span><br><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">docker:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">docker</span> <span class="comment"># 声明后，流水线容器会自动启动dind服务且主动注入docker cli工具</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">database</span> <span class="string">and</span> <span class="string">service</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">docker-compose</span> <span class="string">up</span> <span class="string">-d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Runs</span> <span class="string">a</span> <span class="string">script</span> <span class="string">that</span> <span class="string">creates</span> <span class="string">a</span> <span class="string">PostgreSQL</span> <span class="string">client,</span> <span class="string">populates</span> <span class="string">the</span> <span class="string">client</span> <span class="string">with</span> <span class="string">data,</span> <span class="string">and</span> <span class="string">retrieves</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">node</span> <span class="string">client.js</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="attr">POSTGRES_HOST:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">            <span class="attr">POSTGRES_PORT:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure><h2 id="文章来源"><a href="#文章来源" class="headerlink" title="文章来源"></a>文章来源</h2><blockquote><p><a target="_blank" rel="noopener" href="https://docs.cnb.cool/zh/build/migrate-to-cnb/migrate-from-github-actions.html">https://docs.cnb.cool/zh/build/migrate-to-cnb/migrate-from-github-actions.html</a></p></blockquote></div></article></div><footer class="bg-gradient-to-r from-purple-700 to-blue-600 text-white py-8 mt-auto"><div class="container mx-auto px-4"><div class="flex flex-col md:flex-row md:justify-between md:items-start space-y-6 md:space-y-0"><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">志强vlog</h3><p class="text-sm opacity-80">感谢您的访问！这里是 王志强 专属博客，分享生活与技术。</p></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">快捷导航</h3><ul class="space-y-2 text-sm opacity-90"><li><a href="/" class="hover:text-yellow-300 transition">Home</a></li><li><a href="/archives" class="hover:text-yellow-300 transition">Archives</a></li><li><a href="/resources" class="hover:text-yellow-300 transition">Rsources</a></li><li><a href="/tags" class="hover:text-yellow-300 transition">Tags</a></li><li><a href="/about" class="hover:text-yellow-300 transition">About</a></li><li><a href="/sitemap.xml" class="hover:text-yellow-300 transition">RSS</a></li></ul></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">友情链接</h3><ul class="space-y-2 text-sm opacity-90"><li><a href="https://cnb.cool/zhiqiangwang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">CNB</a></li><li><a href="https://github.com/chihqiang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">GitHub</a></li><li><a href="https://www.zhiqiang.wang" target="_blank" rel="noopener" class="hover:text-yellow-300 transition">志强vlog</a></li></ul></div><div class="md:w-1/4"><h3 class="text-xl font-semibold mb-3">联系方式</h3><p class="text-sm opacity-80 flex items-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-18 8h18a2 2 0 002-2V8a2 2 0 00-2-2H3a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg> <a href="mailto:zhiqiang2033@gmail.com" class="hover:text-yellow-300">zhiqiang2033@gmail.com</a></p><p class="text-sm opacity-80 flex items-center space-x-2 mt-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 21s8-4.5 8-10a8 8 0 10-16 0c0 5.5 8 10 8 10z"/></svg> <span>中国</span></p></div></div><hr class="my-6 border-purple-400 opacity-50"><p class="text-center text-sm opacity-70 mb-2">© 2024 志强vlog. 保留所有权利.</p><p class="text-center text-xs opacity-50">由 <a href="https://hexo.io/" target="_blank" rel="noopener" class="underline hover:text-yellow-300">Hexo</a> 驱动，主题由 <a href="https://github.com/chihqiang/hexo-theme-tailog" target="_blank" rel="noopener" class="underline hover:text-yellow-300">hexo-theme-tailog</a> 提供。</p></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-TBH6G20B8Y"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TBH6G20B8Y")</script></footer><button id="back-to-top" class="fixed bottom-8 right-8 bg-gradient-to-r from-purple-500 to-blue-500 text-white p-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 opacity-0 invisible z-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg></button></body></html>